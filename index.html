<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LendTrack - Money Tracker with Cloud Backup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px 15px; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
        }
        .header h1 { font-size: 2.2em; margin-bottom: 8px; font-weight: 700; }
        .header p { font-size: 1em; opacity: 0.9; }
        .sync-status {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.9);
        }
        .sync-status.synced { background: rgba(76,175,80,0.8); }
        .sync-status.syncing { background: rgba(255,193,7,0.8); }
        .sync-status.error { background: rgba(244,67,54,0.8); }
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            user-select: none;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .tab:hover:not(.active) { background: #f8f9ff; transform: translateY(-2px);}
        .tab-icon { font-size: 18px; margin-bottom: 3px; }
        .tab-text { font-size: 11px; font-weight: 500; }
        .content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.6em;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
            padding-bottom: 8px;
        }
        .hidden { display: none; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        input, textarea, select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 16px; transition: all 0.3s ease; background: #fafafa;
        }
        input:focus, textarea:focus, select:focus {
            outline: none; border-color: #667eea; background: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 14px 25px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 16px; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);}
        .btn-success {background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);}
        .btn-danger {background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);}
        .btn-info {background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);}
        .auth-container { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
        .auth-title { text-align: center; margin-bottom: 25px; color: #667eea; font-size: 2em; font-weight: 700;}
        .person-card {
            background: linear-gradient(120deg, #f3f3fa 0%, #e8ecfa 100%);
            padding: 0 0 18px 0;
            margin-bottom: 18px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(120, 110, 200, 0.08);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .person-card:hover { background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15);}
        .person-card .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.3s ease;
            z-index: 2;
        }
        .person-card .delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: #ff0000;
        }
        .person-name { font-weight: 700; font-size: 1.17em; margin: 18px 0 8px 0; color: #2c3e50;}
        .person-details { color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 5px; text-align: center;}
        .modern-summary-grid {
            width: 95%;
            display: grid;
            grid-template-columns: repeat(2, minmax(120px, 1fr));
            gap: 16px 20px;
            margin: 0 auto 12px auto;
        }
        @media (max-width: 800px) { .modern-summary-grid { grid-template-columns: 1fr; } }
        .modern-summary-card {
            background: linear-gradient(120deg, #f3f3fa 0%, #e8ecfa 100%);
            border-radius: 13px;
            box-shadow: 0 3px 18px rgba(118, 75, 162, 0.07);
            padding: 18px 7px 11px 7px;
            text-align: center;
            border: 1.5px solid #ececff;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modern-icon {
            font-size: 25px;
            margin-bottom: 5px;
            color: #754ba2;
            background: linear-gradient(90deg, #7f68e5 70%, #fad5ee 130%);
            border-radius: 50%;
            width: 33px;
            height: 33px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #aaa1e533;
        }
        .modern-label {
            font-size: 12.5px;
            color: #8686ad;
            margin-bottom: 4px;
            font-weight: 550;
            letter-spacing: 0.01em;
        }
        .modern-value {
            font-size: 1.15em;
            font-weight: bold;
            color: #2a2846;
            margin-bottom: 0px;
        }
        .modern-summary-card.principal  .modern-icon { background:linear-gradient(90deg,#acd8e6 70%,#f7ecfd 130%); color: #0c90c4;}
        .modern-summary-card.interest   .modern-icon { background:linear-gradient(90deg,#ffeec2 60%,#fff9ef 140%); color: #ffa900;}
        .modern-summary-card.repaid     .modern-icon { background:linear-gradient(90deg,#dbe9be 80%,#f4fdd9 130%); color: #62a656;}
        .modern-summary-card.netdue     .modern-icon { background:linear-gradient(90deg,#f8c7d6 60%,#fcf3f8 140%); color: #d73453;}
        .modern-summary-card.netdue .modern-value { color: #d73453;}
        .modern-summary-card.repaid .modern-value { color: #348d3c;}
        .modern-summary-card.interest .modern-value { color: #ffb006;}
        .modern-summary-card.principal .modern-value { color: #2385b6;}
        .balance {
            margin-top: 5px;
            font-weight: 700;
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            user-select: none;
        }
        .balance.positive { background: #ffebee; color: #c62828; border: 2px solid #ffcdd2; }
        .balance.negative { background: #e8f5e8; color: #2e7d32; border: 2px solid #c8e6c9; }
        .no-data { text-align: center; color: #666; font-style: italic; padding: 30px; background: #f8f9ff; border-radius: 10px; margin: 15px 0;}
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(5px);}
        .modal-content { background: white; margin: 20px; padding: 20px; border-radius: 15px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #999; transition: color 0.3s ease;}
        .close:hover { color: #333;}
        .transaction-item { background: white; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 4px solid #4CAF50; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
        .transaction-item.loan { border-left-color: #f44336;}
        .cloud-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8f1 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #4CAF50;
        }
        .cloud-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;}
        .reports-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1.5px solid #e0e0e0; }
        .reports-main-figure { font-size: 2em; font-weight: 700; margin-bottom: 8px; color: #667eea;}
        .reports-label { color: #555; font-size: 1.0em;}
        @media (max-width: 768px) {
            .container { padding: 15px 10px;}
            .header { padding: 20px 15px;}
            .header h1 { font-size: 1.8em;}
            .tabs { flex-direction: row; overflow-x: auto; -webkit-overflow-scrolling: touch;}
            .tab { min-width: 70px; padding: 12px 8px; flex-shrink: 0;}
            .tab-icon { font-size: 16px;}
            .tab-text { font-size: 10px;}
            .content { padding: 15px;}
            .content h2 { font-size: 1.4em;}
            .modern-summary-grid, .reports-grid, .cloud-status { grid-template-columns: 1fr;}
            .person-card { padding: 15px;}
            .person-name { font-size: 1.1em;}
            .person-details { font-size: 13px;}
            .balance { font-size: 1em;}
            .modal-content { margin: 10px; padding: 15px; max-height: 90vh;}
            .auth-container { margin: 30px auto; padding: 25px;}
            .auth-title { font-size: 1.8em;}
            .reports-main-figure { font-size: 1.5em;}
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px;">Connecting to Firebase...</p>
    </div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container hidden">
        <h2 class="auth-title">🏦 LendTrack</h2>
        <div id="firebaseAuth">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Sign In to Sync Your Data</h3>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter password (min 6 chars)" required>
            </div>
            <button onclick="signIn()" class="btn-success">Sign In</button>
            <p style="margin: 10px 0; text-align: center; color: #666;">or</p>
            <button onclick="signUp()" class="btn-info">Create New Account</button>
            <div id="authStatus" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <div class="sync-status" id="syncStatus">🔄 Syncing...</div>
            <h1>💰 LendTrack</h1>
            <p>Money Lending Tracker with Cloud Backup</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">
                <div class="tab-icon">🏠</div>
                <div class="tab-text">Home</div>
            </button>
            <button class="tab" onclick="showTab('add')">
                <div class="tab-icon">➕</div>
                <div class="tab-text">Add Person</div>
            </button>
            <button class="tab" onclick="showTab('reports')">
                <div class="tab-icon">📊</div>
                <div class="tab-text">Reports</div>
            </button>
            <button class="tab" onclick="showTab('calculator')">
                <div class="tab-icon">🧮</div>
                <div class="tab-text">Calculator</div>
            </button>
            <button class="tab" onclick="showTab('cloud')">
                <div class="tab-icon">☁️</div>
                <div class="tab-text">Cloud</div>
            </button>
        </div>

        <!-- Home Tab -->
        <div id="homeTab" class="content">
            <h2>People You've Lent Money To</h2>
            <div id="peopleList"></div>
        </div>

        <!-- Add Person Tab -->
        <div id="addTab" class="content hidden">
            <h2>Add New Person</h2>
            <form id="addPersonForm">
                <div class="form-group">
                    <label for="personName">Name *</label>
                    <input type="text" id="personName" required>
                </div>
                <div class="form-group">
                    <label for="personPhone">Phone (Optional)</label>
                    <input type="tel" id="personPhone">
                </div>
                <div class="form-group">
                    <label for="lendDate">Date of Lending *</label>
                    <input type="date" id="lendDate" required>
                </div>
                <div class="form-group">
                    <label for="lendAmount">Amount *</label>
                    <input type="number" id="lendAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="interestRate">Interest Rate (% per month) *</label>
                    <input type="number" id="interestRate" step="0.01" required placeholder="e.g., 2.5">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" rows="3" placeholder="Why you lent the money..."></textarea>
                </div>
                <button type="submit" class="btn-success">Add Person</button>
            </form>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="content hidden">
            <h2>Reports</h2>
            <div id="reportsGrid" class="reports-grid"></div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculatorTab" class="content hidden">
            <h2>Interest Calculator</h2>
            <form id="calculatorForm">
                <div class="form-group">
                    <label for="calcPerson">Select Person</label>
                    <select id="calcPerson" required>
                        <option value="">Select a person...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="calcDate">Calculate up to Date</label>
                    <input type="date" id="calcDate" required>
                </div>
                <button type="submit" class="btn-success">Calculate</button>
            </form>
            <div id="calculatorResult" class="hidden">
                <h3 style="margin: 20px 0 15px 0; color: #2c3e50;">Calculation Results</h3>
                <div class="modern-summary-grid">
                    <div class="modern-summary-card principal">
                        <div class="modern-icon">💵</div>
                        <div class="modern-label">Original Principal</div>
                        <div class="modern-value" id="originalPrincipal">₹0</div>
                    </div>
                    <div class="modern-summary-card interest">
                        <div class="modern-icon">💡</div>
                        <div class="modern-label">Total Interest</div>
                        <div class="modern-value" id="totalInterest">₹0</div>
                    </div>
                    <div class="modern-summary-card repaid">
                        <div class="modern-icon">↩️</div>
                        <div class="modern-label">Total Repaid</div>
                        <div class="modern-value" id="totalRepaid">₹0</div>
                    </div>
                    <div class="modern-summary-card netdue">
                        <div class="modern-icon">🧾</div>
                        <div class="modern-label">Net Amount Due</div>
                        <div class="modern-value" id="netAmountDue">₹0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloud Backup Tab -->
        <div id="cloudTab" class="content hidden">
            <h2>☁️ Cloud Backup Status</h2>
            <div class="cloud-info">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">🔄 Real-Time Sync</h3>
                <p>Your data is automatically backed up to Firebase every time you make changes. No manual backup needed!</p>
            </div>
            <div class="cloud-status">
                <div class="status-card">
                    <h4>📊 Sync Status</h4>
                    <p id="lastSync">Last sync: Never</p>
                    <p id="dataCount">0 people, 0 transactions backed up</p>
                </div>
                <div class="status-card">
                    <h4>👤 Account</h4>
                    <p id="userEmail">Not signed in</p>
                    <button onclick="signOut()" class="btn-danger" style="margin-top: 10px;">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Person Detail Modal -->
    <div id="personModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalPersonName" style="margin-bottom: 15px; color: #2c3e50;"></h2>
            <div id="modalPersonDetails" style="margin-bottom: 20px;"></div>
            <h3 style="margin-bottom: 12px; color: #2c3e50;">Add Repayment</h3>
            <form id="repaymentForm">
                <div class="form-group">
                    <label for="repayAmount">Amount</label>
                    <input type="number" id="repayAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="repayDate">Date</label>
                    <input type="date" id="repayDate" required>
                </div>
                <div class="form-group">
                    <label for="repayRemarks">Remarks</label>
                    <input type="text" id="repayRemarks" placeholder="Optional">
                </div>
                <button type="submit" class="btn-success">Add Repayment</button>
            </form>
            <h3 style="margin: 20px 0 12px 0; color: #2c3e50;">Transaction History</h3>
            <div id="transactionHistory"></div>
        </div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDBMAEDZ5cthmlj3-WWWFyDbvhTjhsPbF4",
            authDomain: "lendtrack-79cc6.firebaseapp.com",
            projectId: "lendtrack-79cc6",
            storageBucket: "lendtrack-79cc6.firebasestorage.app",
            messagingSenderId: "406324179619",
            appId: "1:406324179619:web:1a71382505c2c707d34516",
            measurementId: "G-MNXWSFXMM5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let currentPersonId = null;
        let peopleData = [];
        let transactionsData = [];
        let repaymentsData = [];

        // Make functions global so HTML can access them
        window.signIn = signIn;
        window.signUp = signUp;
        window.signOut = signOut;
        window.showTab = showTab;
        window.closeModal = closeModal;
        window.addPerson = addPerson;
        window.addRepayment = addRepayment;
        window.deletePerson = deletePerson;
        window.showPersonDetail = showPersonDetail;
        window.calculateInterest = calculateInterest;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const today = getCurrentDate();
            const todayString = getCurrentDateString();
            
            // Set default dates
            document.getElementById('lendDate').value = todayString;
            document.getElementById('repayDate').value = todayString;
            document.getElementById('calcDate').value = todayString;
            
            // Setup form listeners
            document.getElementById('addPersonForm').addEventListener('submit', addPerson);
            document.getElementById('repaymentForm').addEventListener('submit', addRepayment);
            document.getElementById('calculatorForm').addEventListener('submit', calculateInterest);
            
            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    loadAllData();
                } else {
                    currentUser = null;
                    showAuthScreen();
                }
                hideLoadingScreen();
            });
        });

        // Authentication functions
        async function signUp() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                showAuthStatus('Please enter both email and password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthStatus('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                showAuthStatus('Creating account...', 'loading');
                await createUserWithEmailAndPassword(auth, email, password);
                showAuthStatus('Account created successfully!', 'success');
            } catch (error) {
                console.error('Sign up error:', error);
                showAuthStatus(getAuthErrorMessage(error.code), 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                showAuthStatus('Please enter both email and password', 'error');
                return;
            }
            
            try {
                showAuthStatus('Signing in...', 'loading');
                await signInWithEmailAndPassword(auth, email, password);
                showAuthStatus('Signed in successfully!', 'success');
            } catch (error) {
                console.error('Sign in error:', error);
                showAuthStatus(getAuthErrorMessage(error.code), 'error');
            }
        }

        async function signOut() {
            try {
                await firebaseSignOut(auth);
                showAuthScreen();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // UI functions
        function showLoadingScreen() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateCloudStatus();
        }

        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.innerHTML = `<div class="auth-message ${type}">${message}</div>`;
            
            // Add CSS for auth messages
            if (!document.querySelector('.auth-message-styles')) {
                const style = document.createElement('style');
                style.className = 'auth-message-styles';
                style.textContent = `
                    .auth-message { padding: 10px; border-radius: 5px; margin-top: 15px; }
                    .auth-message.success { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
                    .auth-message.error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
                    .auth-message.loading { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
                `;
                document.head.appendChild(style);
            }
        }

        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/user-not-found': 'No account found with this email address.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/email-already-in-use': 'An account with this email already exists.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later.'
            };
            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.className = `sync-status ${status}`;
            syncStatus.textContent = message;
        }

        function updateCloudStatus() {
            if (currentUser) {
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('lastSync').textContent = `Last sync: ${new Date().toLocaleString()}`;
                document.getElementById('dataCount').textContent = `${peopleData.length} people, ${transactionsData.length} transactions backed up`;
            }
        }

        // Data functions
        async function loadAllData() {
            if (!currentUser) return;
            
            try {
                updateSyncStatus('syncing', '🔄 Loading data...');
                
                // Load people
                const peopleQuery = query(collection(db, 'people'), where('userId', '==', currentUser.uid));
                const peopleSnapshot = await getDocs(peopleQuery);
                peopleData = peopleSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load transactions
                const transactionsQuery = query(collection(db, 'transactions'), where('userId', '==', currentUser.uid));
                const transactionsSnapshot = await getDocs(transactionsQuery);
                transactionsData = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load repayments
                const repaymentsQuery = query(collection(db, 'repayments'), where('userId', '==', currentUser.uid));
                const repaymentsSnapshot = await getDocs(repaymentsQuery);
                repaymentsData = repaymentsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateSyncStatus('synced', '✅ Synced');
                loadPeople();
                updateReports();
                populateCalculatorDropdown();
                updateCloudStatus();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('error', '❌ Sync error');
            }
        }

        // Utility functions
        function getCurrentDate() { return new Date(); }
        function getCurrentDateString() { return getCurrentDate().toISOString().split('T')[0]; }

        function getDaysBetween(startDate, endDate) {
            const start = new Date(startDate), end = new Date(endDate);
            const timeDiff = end.getTime() - start.getTime();
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        function calculateDailyInterest(principal, monthlyRate, days) {
            const dailyRate = monthlyRate / 30;
            return principal * (dailyRate / 100) * days;
        }

        function calculateInterestForPersonWithRepayments(personId, upToDate) {
            const personTransactions = transactionsData.filter(t => t.personId === personId);
            const personRepayments = repaymentsData.filter(r =>
                personTransactions.some(t => t.id === r.transactionId)
            ).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let totalPrincipal = 0, totalInterest = 0, totalRepaid = 0;
            
            personTransactions.forEach(transaction => {
                const principal = transaction.amount;
                const interestRate = transaction.interestRate;
                const startDate = new Date(transaction.date);
                const endDate = new Date(upToDate);
                totalPrincipal += principal;
                
                const transactionRepayments = personRepayments.filter(r => r.transactionId === transaction.id);
                totalRepaid += transactionRepayments.reduce((sum, r) => sum + r.amount, 0);
                
                let currentPrincipal = principal, currentDate = new Date(startDate), transactionInterest = 0;
                let events = transactionRepayments.map(r => ({
                    date: new Date(r.date), type: 'repayment', amount: r.amount
                }));
                events.push({ date: endDate, type: 'calculation_end', amount: 0 });
                events.sort((a, b) => a.date - b.date);
                
                events.forEach(event => {
                    if (event.date >= currentDate && currentPrincipal > 0) {
                        const days = getDaysBetween(currentDate, event.date);
                        const periodInterest = calculateDailyInterest(currentPrincipal, interestRate, days);
                        transactionInterest += periodInterest;
                        currentDate = new Date(event.date);
                        if (event.type === 'repayment') currentPrincipal = Math.max(0, currentPrincipal - event.amount);
                    }
                });
                totalInterest += transactionInterest;
            });
            
            const netAmountDue = totalPrincipal + totalInterest - totalRepaid;
            return { originalPrincipal: totalPrincipal, totalInterest, totalRepaid, netAmountDue };
        }

        // App functions
        async function addPerson(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const name = document.getElementById('personName').value.trim();
            const phone = document.getElementById('personPhone').value.trim();
            const date = document.getElementById('lendDate').value;
            const amount = parseFloat(document.getElementById('lendAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const remarks = document.getElementById('remarks').value.trim();
            
            if (!name || !date || !amount || amount <= 0 || !interestRate || interestRate < 0) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                updateSyncStatus('syncing', '🔄 Saving...');
                
                // Add person to Firebase
                const personDoc = await addDoc(collection(db, 'people'), {
                    userId: currentUser.uid,
                    name,
                    phone: phone || null,
                    createdAt: new Date().toISOString()
                });
                
                // Add transaction to Firebase
                await addDoc(collection(db, 'transactions'), {
                    userId: currentUser.uid,
                    personId: personDoc.id,
                    amount,
                    interestRate,
                    date,
                    remarks,
                    type: 'loan',
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('addPersonForm').reset();
                document.getElementById('lendDate').value = getCurrentDateString();
                
                updateSyncStatus('synced', '✅ Saved');
                alert('Person added successfully!');
                await loadAllData();
                showTab('home');
                
            } catch (error) {
                console.error('Error adding person:', error);
                updateSyncStatus('error', '❌ Save failed');
                alert('Error saving data. Please try again.');
            }
        }

        async function deletePerson(personId) {
            if (!currentUser || !confirm('Are you sure you want to delete this person and all their data?')) return;
            
            try {
                updateSyncStatus('syncing', '🔄 Deleting...');
                
                // Delete person
                await deleteDoc(doc(db, 'people', personId));
                
                // Delete associated transactions and repayments
                const personTransactions = transactionsData.filter(t => t.personId === personId);
                for (const transaction of personTransactions) {
                    await deleteDoc(doc(db, 'transactions', transaction.id));
                    
                    const transactionRepayments = repaymentsData.filter(r => r.transactionId === transaction.id);
                    for (const repayment of transactionRepayments) {
                        await deleteDoc(doc(db, 'repayments', repayment.id));
                    }
                }
                
                updateSyncStatus('synced', '✅ Deleted');
                await loadAllData();
                alert('Person deleted successfully!');
                
            } catch (error) {
                console.error('Error deleting person:', error);
                updateSyncStatus('error', '❌ Delete failed');
                alert('Error deleting person. Please try again.');
            }
        }

        async function addRepayment(e) {
            e.preventDefault();
            if (!currentUser || !currentPersonId) return;
            
            const amount = parseFloat(document.getElementById('repayAmount').value);
            const date = document.getElementById('repayDate').value;
            const remarks = document.getElementById('repayRemarks').value.trim();
            
            if (!amount || amount <= 0 || !date) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                updateSyncStatus('syncing', '🔄 Saving...');
                
                const personTransactions = transactionsData.filter(t => t.personId === currentPersonId);
                if (personTransactions.length === 0) {
                    alert('No loan transactions found for this person');
                    return;
                }
                
                const latestTransaction = personTransactions[personTransactions.length - 1];
                
                await addDoc(collection(db, 'repayments'), {
                    userId: currentUser.uid,
                    transactionId: latestTransaction.id,
                    amount,
                    date,
                    remarks,
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('repaymentForm').reset();
                document.getElementById('repayDate').value = getCurrentDateString();
                
                updateSyncStatus('synced', '✅ Saved');
                alert('Repayment added successfully!');
                await loadAllData();
                showPersonDetail(currentPersonId);
                
            } catch (error) {
                console.error('Error adding repayment:', error);
                updateSyncStatus('error', '❌ Save failed');
                alert('Error saving repayment. Please try again.');
            }
        }

        function loadPeople() {
            const peopleList = document.getElementById('peopleList');
            if (peopleData.length === 0) {
                peopleList.innerHTML = '<div class="no-data">No people added yet. Click "Add Person" to get started!</div>';
                return;
            }
            
            peopleList.innerHTML = '';
            const today = getCurrentDateString();
            
            peopleData.forEach(person => {
                const calculation = calculateInterestForPersonWithRepayments(person.id, today);
                const personCard = document.createElement('div');
                personCard.className = 'person-card';
                personCard.onclick = (e) => {
                    if (e.target.classList.contains('delete-btn')) return;
                    showPersonDetail(person.id);
                };
                
                personCard.innerHTML = `
                    <button class="delete-btn" onclick="event.stopPropagation(); deletePerson('${person.id}');" title="Delete Person">×</button>
                    <div class="person-name">${person.name}</div>
                    <div class="person-details">${person.phone ? `📞 ${person.phone}<br>` : ''}</div>
                    <div class="modern-summary-grid">
                        <div class="modern-summary-card principal">
                            <div class="modern-icon">💵</div>
                            <div class="modern-label">Original Principal</div>
                            <div class="modern-value">₹${calculation.originalPrincipal.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="modern-summary-card interest">
                            <div class="modern-icon">💡</div>
                            <div class="modern-label">Interest Accrued</div>
                            <div class="modern-value">₹${calculation.totalInterest.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="modern-summary-card repaid">
                            <div class="modern-icon">↩️</div>
                            <div class="modern-label">Total Repaid</div>
                            <div class="modern-value">₹${calculation.totalRepaid.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="modern-summary-card netdue">
                            <div class="modern-icon">🧾</div>
                            <div class="modern-label">Net Amount Due</div>
                            <div class="modern-value">₹${calculation.netAmountDue.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div class="balance ${calculation.netAmountDue > 0 ? 'positive' : 'negative'}">
                        Net Amount Due: ₹${calculation.netAmountDue.toLocaleString(undefined, {maximumFractionDigits: 2})}
                    </div>
                `;
                peopleList.appendChild(personCard);
            });
        }

        function showPersonDetail(personId) {
            currentPersonId = personId;
            const person = peopleData.find(p => p.id === personId);
            const personTransactions = transactionsData.filter(t => t.personId === personId);
            const personRepayments = repaymentsData.filter(r =>
                personTransactions.some(t => t.id === r.transactionId)
            );
            
            document.getElementById('modalPersonName').textContent = person.name;
            const today = getCurrentDateString();
            const calculation = calculateInterestForPersonWithRepayments(personId, today);
            
            document.getElementById('modalPersonDetails').innerHTML = `
                <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p><strong>Phone:</strong> ${person.phone || 'Not provided'}</p>
                    <p><strong>Original Principal:</strong> ₹${calculation.originalPrincipal.toFixed(2)}</p>
                    <p><strong>Interest Accrued:</strong> ₹${calculation.totalInterest.toFixed(2)}</p>
                    <p><strong>Total Repaid:</strong> ₹${calculation.totalRepaid.toFixed(2)}</p>
                    <p><strong>Net Amount Due:</strong> ₹${calculation.netAmountDue.toFixed(2)}</p>
                </div>
            `;
            
            const historyDiv = document.getElementById('transactionHistory');
            historyDiv.innerHTML = '';
            
            personTransactions.forEach(transaction => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'transaction-item loan';
                itemDiv.innerHTML = `
                    <div><strong>Loan:</strong> ₹${transaction.amount.toFixed(2)} @ ${transaction.interestRate}% per month</div>
                    <div><strong>Date:</strong> ${transaction.date}</div>
                    ${transaction.remarks ? `<div><strong>Remarks:</strong> ${transaction.remarks}</div>` : ''}
                `;
                historyDiv.appendChild(itemDiv);
            });
            
            personRepayments.forEach(repayment => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'transaction-item';
                itemDiv.innerHTML = `
                    <div><strong>Repayment:</strong> ₹${repayment.amount.toFixed(2)}</div>
                    <div><strong>Date:</strong> ${repayment.date}</div>
                    ${repayment.remarks ? `<div><strong>Remarks:</strong> ${repayment.remarks}</div>` : ''}
                `;
                historyDiv.appendChild(itemDiv);
            });
            
            document.getElementById('personModal').style.display = 'block';
        }

        function populateCalculatorDropdown() {
            const dropdown = document.getElementById('calcPerson');
            dropdown.innerHTML = '<option value="">Select a person...</option>';
            peopleData.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                dropdown.appendChild(option);
            });
        }

        function calculateInterest(e) {
            e.preventDefault();
            const personId = document.getElementById('calcPerson').value;
            const upToDate = document.getElementById('calcDate').value;
            
            if (!personId || !upToDate) {
                alert('Please select a person and date');
                return;
            }
            
            const calculation = calculateInterestForPersonWithRepayments(personId, upToDate);
            document.getElementById('originalPrincipal').textContent = `₹${calculation.originalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `₹${calculation.totalInterest.toFixed(2)}`;
            document.getElementById('totalRepaid').textContent = `₹${calculation.totalRepaid.toFixed(2)}`;
            document.getElementById('netAmountDue').textContent = `₹${calculation.netAmountDue.toFixed(2)}`;
            
            document.getElementById('calculatorResult').classList.remove('hidden');
        }

        function updateReports() {
            const today = getCurrentDateString();
            let totalPrincipal = 0, totalInterest = 0, totalRepaid = 0, totalOutstanding = 0;
            
            peopleData.forEach(person => {
                const calculation = calculateInterestForPersonWithRepayments(person.id, today);
                totalPrincipal += calculation.originalPrincipal;
                totalInterest += calculation.totalInterest;
                totalRepaid += calculation.totalRepaid;
                totalOutstanding += calculation.netAmountDue;
            });
            
            const reportsGrid = document.getElementById('reportsGrid');
            reportsGrid.innerHTML = `
                <div class="reports-card">
                    <div class="reports-main-figure">₹${totalPrincipal.toFixed(2)}</div>
                    <div class="reports-label">Total Amount Lent</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">${peopleData.length}</div>
                    <div class="reports-label">Total Persons Lent</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">₹${totalInterest.toFixed(2)}</div>
                    <div class="reports-label">Total Interest Earned</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">₹${totalRepaid.toFixed(2)}</div>
                    <div class="reports-label">Total Repayments Made</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">₹${totalOutstanding.toFixed(2)}</div>
                    <div class="reports-label">Total Amount Outstanding</div>
                </div>
            `;
        }

        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            // Close modal when switching tabs
            closeModal();
            
            if (tabName === 'home') loadPeople();
            else if (tabName === 'calculator') populateCalculatorDropdown();
            else if (tabName === 'reports') updateReports();
            else if (tabName === 'cloud') updateCloudStatus();
        }

        function closeModal() {
            document.getElementById('personModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('personModal');
            if (event.target === modal) closeModal();
        }

    </script>
</body>
</html>
