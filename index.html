<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LendTrack - Money Tracker with Interest</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px 15px; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 2.2em; margin-bottom: 8px; font-weight: 700; }
        .header p { font-size: 1em; opacity: 0.9; }
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            user-select: none;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .tab:hover:not(.active) {
            background: #f8f9ff;
            transform: translateY(-2px);
        }
        .tab-icon {
            font-size: 18px;
            margin-bottom: 3px;
        }
        .tab-text {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }
        .content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.6em;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
            padding-bottom: 8px;
        }
        .hidden { display: none; }
        .form-group { margin-bottom: 18px; }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }
        input[type="file"] {
            padding: 8px;
            background: white;
            border: 2px dashed #667eea;
            border-radius: 8px;
            cursor: pointer;
        }
        input[type="file"]:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
        .btn-danger:hover { box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .btn-warning:hover { box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); }
        .btn-info { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
        .btn-info:hover { box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4); }
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.3s ease;
            z-index: 2;
        }
        .delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: #ff0000;
        }
        .person-card {
            background: linear-gradient(120deg, #f3f3fa 0%, #e8ecfa 100%);
            padding: 0 0 18px 0;
            margin-bottom: 18px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(120, 110, 200, 0.08);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .person-card:hover {
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .person-name {
            font-weight: 700;
            font-size: 1.17em;
            margin: 18px 0 8px 0;
            color: #2c3e50;
        }
        .person-details {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 5px;
            text-align: center;
        }
        .modern-summary-grid {
            width: 95%;
            display: grid;
            grid-template-columns: repeat(2, minmax(120px, 1fr));
            gap: 16px 20px;
            margin: 0 auto 12px auto;
        }
        @media (max-width: 800px) {
            .modern-summary-grid {
                grid-template-columns: 1fr;
            }
        }
        .modern-summary-card {
            background: linear-gradient(120deg, #f3f3fa 0%, #e8ecfa 100%);
            border-radius: 13px;
            box-shadow: 0 3px 18px rgba(118, 75, 162, 0.07);
            padding: 18px 7px 11px 7px;
            text-align: center;
            border: 1.5px solid #ececff;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modern-icon {
            font-size: 25px;
            margin-bottom: 5px;
            color: #754ba2;
            background: linear-gradient(90deg, #7f68e5 70%, #fad5ee 130%);
            border-radius: 50%;
            width: 33px;
            height: 33px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #aaa1e533;
        }
        .modern-label {
            font-size: 12.5px;
            color: #8686ad;
            margin-bottom: 4px;
            font-weight: 550;
            letter-spacing: 0.01em;
        }
        .modern-value {
            font-size: 1.15em;
            font-weight: bold;
            color: #2a2846;
            margin-bottom: 0px;
        }
        .modern-summary-card.principal  .modern-icon { background:linear-gradient(90deg,#acd8e6 70%,#f7ecfd 130%); color: #0c90c4;}
        .modern-summary-card.interest   .modern-icon { background:linear-gradient(90deg,#ffeec2 60%,#fff9ef 140%); color: #ffa900;}
        .modern-summary-card.repaid     .modern-icon { background:linear-gradient(90deg,#dbe9be 80%,#f4fdd9 130%); color: #62a656;}
        .modern-summary-card.netdue     .modern-icon { background:linear-gradient(90deg,#f8c7d6 60%,#fcf3f8 140%); color: #d73453;}
        .modern-summary-card.netdue .modern-value { color: #d73453;}
        .modern-summary-card.repaid .modern-value { color: #348d3c;}
        .modern-summary-card.interest .modern-value { color: #ffb006;}
        .modern-summary-card.principal .modern-value { color: #2385b6;}
        .balance {
            margin-top: 5px;
            font-weight: 700;
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            user-select: none;
        }
        .balance.positive { background: #ffebee; color: #c62828; border: 2px solid #ffcdd2; }
        .balance.negative { background: #e8f5e8; color: #2e7d32; border: 2px solid #c8e6c9; }
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
            background: #f8f9ff;
            border-radius: 10px;
            margin: 15px 0;
        }
        .calculator-result {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8f1 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #4caf50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .interest-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            background: white;
        }
        .interest-table th,
        .interest-table td {
            border: 1px solid #e0e0e0;
            padding: 10px 8px;
            text-align: left;
            font-size: 13px;
        }
        .interest-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .interest-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }
        .interest-table tr:hover {
            background-color: #f0f2ff;
        }
        .repayment-highlight {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            border: 2px solid #ffc107 !important;
        }
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .forecast-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .forecast-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .forecast-header {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 6px;
        }
        .forecast-amount {
            font-size: 1.6em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .forecast-label {
            color: #666;
            font-size: 12px;
        }
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
            background: #f8f9ff;
            border-radius: 10px;
            margin: 15px 0;
        }
        .forecast-selector {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .export-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        .import-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #ffcc02;
        }
        .danger-section {
            background: #ffebee;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #ffcdd2;
        }
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .reports-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1.5px solid #e0e0e0;
            user-select: none;
        }
        .reports-main-figure {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #667eea;
        }
        .reports-label {
            color: #555;
            font-size: 1em;
        }
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #4caf50;
            font-weight: 600;
            user-select: none;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #f44336;
            font-weight: 600;
            user-select: none;
        }
        @media (max-width: 768px) {
            .container { padding: 15px 10px; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 1.8em; }
            .tabs { flex-direction: row; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab { min-width: 70px; padding: 12px 8px; flex-shrink: 0; }
            .tab-icon { font-size: 16px; }
            .tab-text { font-size: 10px; }
            .content { padding: 15px; }
            .content h2 { font-size: 1.4em; }
            .summary-grid, .calculator-grid, .forecast-grid, .reports-grid { grid-template-columns: 1fr; }
            .export-buttons { grid-template-columns: 1fr; }
            .person-card { padding: 15px; }
            .person-name { font-size: 1.1em; }
            .person-details { font-size: 13px; }
            .balance { font-size: 1em; }
            .modal-content { margin: 10px; padding: 15px; max-height: 90vh; }
            .auth-container { margin: 30px auto; padding: 25px; }
            .auth-title { font-size: 1.8em; }
            .summary-amount, .reports-main-figure { font-size: 1.5em; }
            .forecast-amount { font-size: 1.4em; }
            .interest-table { min-width: 500px; }
            .interest-table th, .interest-table td { padding: 8px 6px; font-size: 12px; }
            .interest-table th { font-size: 11px; }
        }
        @media (max-width: 480px) {
            .container { padding: 10px 5px; }
            .header { padding: 15px 10px; }
            .header h1 { font-size: 1.6em; }
            .content { padding: 12px; }
            .person-card { padding: 12px; }
            .tab { min-width: 60px; padding: 10px 5px; }
            .tab-icon { font-size: 14px; }
            .tab-text { font-size: 9px; }
            .interest-table { min-width: 450px; }
            .interest-table th, .interest-table td { padding: 6px 4px; font-size: 11px; }
            .modal-content { margin: 5px; padding: 12px; }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <h2 class="auth-title">üè¶ LendTrack</h2>
        <div id="setupForm">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Setup Your Account</h3>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" placeholder="Enter your name" required />
            </div>
            <div class="form-group">
                <label for="pin">PIN (Optional):</label>
                <input type="password" id="pin" placeholder="4-digit PIN (optional)" maxlength="4" />
            </div>
            <button onclick="setupUser()">Create Account</button>
        </div>
        <div id="loginForm" class="hidden">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Enter PIN</h3>
            <div class="form-group">
                <label for="loginPin">PIN:</label>
                <input type="password" id="loginPin" placeholder="Enter your PIN" maxlength="4" />
            </div>
            <button onclick="loginUser()">Login</button>
        </div>
    </div>
    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>üí∞ LendTrack</h1>
            <p>Money Lending Tracker with Interest Calculator</p>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">
                <div class="tab-icon">üè†</div>
                <div class="tab-text">Home</div>
            </button>
            <button class="tab" onclick="showTab('add')">
                <div class="tab-icon">‚ûï</div>
                <div class="tab-text">Add Person</div>
            </button>
            <button class="tab" onclick="showTab('reports')">
                <div class="tab-icon">üìä</div>
                <div class="tab-text">Reports</div>
            </button>
            <button class="tab" onclick="showTab('calculator')">
                <div class="tab-icon">üßÆ</div>
                <div class="tab-text">Calculator</div>
            </button>
            <button class="tab" onclick="showTab('forecast')">
                <div class="tab-icon">üìà</div>
                <div class="tab-text">Forecast</div>
            </button>
            <button class="tab" onclick="showTab('export')">
                <div class="tab-icon">üì§</div>
                <div class="tab-text">Backup</div>
            </button>
        </div>
        <!-- Home Tab -->
        <div id="homeTab" class="content">
            <h2>People You've Lent Money To</h2>
            <div id="peopleList"></div>
        </div>
        <!-- Add Person Tab -->
        <div id="addTab" class="content hidden">
            <h2>Add New Person</h2>
            <form id="addPersonForm">
                <div class="form-group">
                    <label for="personName">Name *</label>
                    <input type="text" id="personName" required />
                </div>
                <div class="form-group">
                    <label for="personPhone">Phone (Optional)</label>
                    <input type="tel" id="personPhone" />
                </div>
                <div class="form-group">
                    <label for="lendDate">Date of Lending *</label>
                    <input type="date" id="lendDate" required />
                </div>
                <div class="form-group">
                    <label for="lendAmount">Amount *</label>
                    <input type="number" id="lendAmount" step="0.01" required />
                </div>
                <div class="form-group">
                    <label for="interestRate">Interest Rate (% per month) *</label>
                    <input
                      type="number"
                      id="interestRate"
                      step="0.01"
                      required
                      placeholder="e.g., 2.5"
                    />
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" rows="3" placeholder="Why you lent the money..."></textarea>
                </div>
                <button type="submit" class="btn-success">Add Person</button>
            </form>
        </div>
        <!-- Reports Tab -->
        <div id="reportsTab" class="content hidden">
            <h2>Reports</h2>
            <div id="reportsGrid" class="reports-grid"></div>
        </div>
        <!-- Calculator Tab -->
        <div id="calculatorTab" class="content hidden">
            <h2>Interest Calculator</h2>
            <form id="calculatorForm">
                <div class="form-group">
                    <label for="calcPerson">Select Person</label>
                    <select id="calcPerson" required>
                        <option value="">Select a person...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="calcDate">Calculate up to Date</label>
                    <input type="date" id="calcDate" required />
                </div>
                <button type="submit" class="btn-success">Calculate</button>
            </form>
            <div id="calculatorResult" class="calculator-result hidden">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Calculation Results</h3>
                <div class="calculator-grid">
                    <div class="summary-card">
                        <div class="summary-amount" id="originalPrincipal">‚Çπ0</div>
                        <div class="summary-label">Original Principal</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-amount" id="totalInterest">‚Çπ0</div>
                        <div class="summary-label">Total Interest</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-amount" id="totalRepaid">‚Çπ0</div>
                        <div class="summary-label">Total Repaid</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-amount" id="netAmountDue">‚Çπ0</div>
                        <div class="summary-label">Net Amount Due</div>
                    </div>
                </div>
                <h4 style="margin: 20px 0 10px 0; color: #2c3e50;">Interest Timeline</h4>
                <div class="table-container">
                    <div id="interestBreakdown"></div>
                </div>
            </div>
        </div>
        <!-- 30-Day Forecast Tab -->
        <div id="forecastTab" class="content hidden">
            <h2>30-Day Forecast</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                Select a person to view their 30-day interest forecast
            </p>
            <div class="forecast-selector">
                <div class="form-group">
                    <label for="forecastPerson">Select Person</label>
                    <select id="forecastPerson" onchange="loadPersonForecast()">
                        <option value="">Select a person...</option>
                    </select>
                </div>
            </div>
            <div id="forecastContent">
                <div class="forecast-grid" id="forecastGrid"></div>
                <div class="table-container">
                    <div id="forecastTable"></div>
                </div>
            </div>
        </div>
        <!-- Export/Import Tab -->
        <div id="exportTab" class="content hidden">
            <h2>Backup &amp; Restore</h2>
            <div class="export-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">üì§ Export Data</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Download your data for safekeeping
                </p>
                <div class="export-buttons">
                    <button onclick="exportToCSV()" class="btn-success">üìä Export as CSV</button>
                    <button onclick="exportToJSON()" class="btn-info">üìÑ Export as JSON Backup</button>
                </div>
            </div>
            <div class="import-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">üì• Import Data</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    Restore your data from a JSON backup file
                </p>
                <div class="form-group">
                    <label for="importFile">Select JSON Backup File</label>
                    <input
                      type="file"
                      id="importFile"
                      accept=".json"
                      onchange="handleFileSelect(event)"
                    />
                </div>
                <button
                  onclick="importFromFile()"
                  class="btn-warning"
                  id="importButton"
                  disabled
                >
                  üì• Import Backup
                </button>
                <div id="importStatus"></div>
            </div>
            <div class="danger-section">
                <h3 style="margin-bottom: 15px; color: #c62828;">‚ö†Ô∏è Danger Zone</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    This action cannot be undone
                </p>
                <button onclick="clearAllData()" class="btn-danger">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>
    <!-- Person Detail Modal -->
    <div id="personModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalPersonName" style="margin-bottom: 15px; color: #2c3e50;"></h2>
            <div id="modalPersonDetails" style="margin-bottom: 20px;"></div>
            <h3 style="margin-bottom: 12px; color: #2c3e50;">Add Repayment</h3>
            <form id="repaymentForm">
                <div class="form-group">
                    <label for="repayAmount">Amount</label>
                    <input type="number" id="repayAmount" step="0.01" required />
                </div>
                <div class="form-group">
                    <label for="repayDate">Date</label>
                    <input type="date" id="repayDate" required />
                </div>
                <div class="form-group">
                    <label for="repayRemarks">Remarks</label>
                    <input type="text" id="repayRemarks" placeholder="Optional" />
                </div>
                <button type="submit" class="btn-success">Add Repayment</button>
            </form>
            <h3 style="margin: 20px 0 12px 0; color: #2c3e50;">Transaction History</h3>
            <div id="transactionHistory"></div>
        </div>
    </div>

    <script>
      let currentUser = null,
        currentPersonId = null,
        selectedFile = null;

      // Get current date helpers
      function getCurrentDate() {
        return new Date();
      }
      function getCurrentDateString() {
        return getCurrentDate().toISOString().split("T")[0];
      }

      // Init app
      document.addEventListener("DOMContentLoaded", function () {
        const today = getCurrentDate();
        document.getElementById("lendDate").valueAsDate = today;
        document.getElementById("repayDate").valueAsDate = today;
        document.getElementById("calcDate").valueAsDate = today;

        const userData = localStorage.getItem("lendtrack_user");
        if (userData) {
          currentUser = JSON.parse(userData);
          if (currentUser.pin) showLoginForm();
          else showMainApp();
        } else showSetupForm();

        document
          .getElementById("addPersonForm")
          .addEventListener("submit", addPerson);
        document
          .getElementById("repaymentForm")
          .addEventListener("submit", addRepayment);
        document
          .getElementById("calculatorForm")
          .addEventListener("submit", calculateInterest);
      });

      // Auth functions
      function showSetupForm() {
        document.getElementById("setupForm").classList.remove("hidden");
        document.getElementById("loginForm").classList.add("hidden");
      }
      function showLoginForm() {
        document.getElementById("setupForm").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
      }
      function setupUser() {
        const username = document.getElementById("username").value.trim();
        const pin = document.getElementById("pin").value.trim();
        if (!username) {
          alert("Please enter a username");
          return;
        }
        if (pin && pin.length < 4) {
          alert("PIN must be at least 4 digits");
          return;
        }
        currentUser = {
          username,
          pin: pin || null,
          createdAt: new Date().toISOString(),
        };
        localStorage.setItem("lendtrack_user", JSON.stringify(currentUser));
        showMainApp();
      }
      function loginUser() {
        const enteredPin = document.getElementById("loginPin").value.trim();
        if (enteredPin === currentUser.pin) showMainApp();
        else {
          alert("Invalid PIN");
          document.getElementById("loginPin").value = "";
        }
      }
      function showMainApp() {
        document.getElementById("authScreen").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        loadPeople();
        populateCalculatorDropdown();
        populateForecastDropdown();
        updateReports();
      }
      function showTab(tabName) {
        document.querySelectorAll(".content").forEach((tab) => tab.classList.add("hidden"));
        document.querySelectorAll(".tab").forEach((tab) => tab.classList.remove("active"));
        document.getElementById(tabName + "Tab").classList.remove("hidden");
        event.target.classList.add("active");
        if (tabName === "home") loadPeople();
        else if (tabName === "forecast") populateForecastDropdown();
        else if (tabName === "calculator") populateCalculatorDropdown();
        else if (tabName === "reports") updateReports();
      }
      // Data utils
      function getPeople() {
        const data = localStorage.getItem("lendtrack_people");
        return data ? JSON.parse(data) : [];
      }
      function savePeople(people) {
        localStorage.setItem("lendtrack_people", JSON.stringify(people));
      }
      function getTransactions() {
        const data = localStorage.getItem("lendtrack_transactions");
        return data ? JSON.parse(data) : [];
      }
      function saveTransactions(transactions) {
        localStorage.setItem("lendtrack_transactions", JSON.stringify(transactions));
      }
      function getRepayments() {
        const data = localStorage.getItem("lendtrack_repayments");
        return data ? JSON.parse(data) : [];
      }
      function saveRepayments(repayments) {
        localStorage.setItem("lendtrack_repayments", JSON.stringify(repayments));
      }
      // Date / Interest utilities
      function getDaysBetween(startDate, endDate) {
        const start = new Date(startDate),
          end = new Date(endDate);
        const timeDiff = end.getTime() - start.getTime();
        return Math.ceil(timeDiff / (1000 * 3600 * 24));
      }
      function calculateDailyInterest(principal, monthlyRate, days) {
        const dailyRate = monthlyRate / 30;
        return principal * (dailyRate / 100) * days;
      }
      function addDaysToDate(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
      }
      // Interest calculation with repayments
      function calculateInterestForPersonWithRepayments(personId, upToDate) {
        const transactions = getTransactions(),
          repayments = getRepayments();
        const personTransactions = transactions.filter((t) => t.personId === personId);
        const personRepayments = repayments
          .filter((r) =>
            personTransactions.some((t) => t.id === r.transactionId)
          )
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        let totalPrincipal = 0,
          totalInterest = 0,
          totalRepaid = 0,
          timeline = [];
        personTransactions.forEach((transaction) => {
          const principal = transaction.amount;
          const interestRate = transaction.interestRate;
          const startDate = new Date(transaction.date);
          const endDate = new Date(upToDate);
          totalPrincipal += principal;
          const transactionRepayments = personRepayments.filter(
            (r) => r.transactionId === transaction.id
          );
          totalRepaid += transactionRepayments.reduce(
            (sum, r) => sum + r.amount,
            0
          );
          let currentPrincipal = principal,
            currentDate = new Date(startDate);
          let transactionInterest = 0;
          let events = transactionRepayments.map((r) => ({
            date: new Date(r.date),
            type: "repayment",
            amount: r.amount,
            remarks: r.remarks,
          }));
          events.push({ date: endDate, type: "calculation_end", amount: 0 });
          events.sort((a, b) => a.date - b.date);
          events.forEach((event) => {
            if (event.date >= currentDate && currentPrincipal > 0) {
              const days = getDaysBetween(currentDate, event.date);
              const periodInterest = calculateDailyInterest(
                currentPrincipal,
                interestRate,
                days
              );
              transactionInterest += periodInterest;
              timeline.push({
                startDate: currentDate.toISOString().split("T")[0],
                endDate: event.date.toISOString().split("T")[0],
                days,
                principal: currentPrincipal,
                interestRate,
                periodInterest,
                event: event.type,
                repaymentAmount: event.amount,
                remarks: event.remarks,
              });
              currentDate = new Date(event.date);
              if (event.type === "repayment")
                currentPrincipal = Math.max(0, currentPrincipal - event.amount);
            }
          });
          totalInterest += transactionInterest;
        });
        const netAmountDue = totalPrincipal + totalInterest - totalRepaid;
        return {
          originalPrincipal: totalPrincipal,
          totalInterest,
          totalRepaid,
          netAmountDue,
          timeline,
        };
      }
      // Delete person and related data
      function deletePerson(personId) {
        if (
          confirm(
            "Are you sure you want to delete this person and all their transactions? This cannot be undone!"
          )
        ) {
          const people = getPeople();
          const transactions = getTransactions();
          const repayments = getRepayments();
          const person = people.find((p) => p.id === personId);
          const personName = person ? person.name : "Unknown";
          if (
            confirm(
              `Delete ${personName} and all associated data?`
            )
          ) {
            const updatedPeople = people.filter((p) => p.id !== personId);
            const personTransactionIds = transactions
              .filter((t) => t.personId === personId)
              .map((t) => t.id);
            const updatedTransactions = transactions.filter(
              (t) => t.personId !== personId
            );
            const updatedRepayments = repayments.filter(
              (r) => !personTransactionIds.includes(r.transactionId)
            );
            savePeople(updatedPeople);
            saveTransactions(updatedTransactions);
            saveRepayments(updatedRepayments);
            loadPeople();
            populateCalculatorDropdown();
            populateForecastDropdown();
            updateReports();
            alert(`${personName} has been deleted successfully!`);
          }
        }
      }
      // Import/export handlers
      function handleFileSelect(event) {
        selectedFile = event.target.files[0];
        const importButton = document.getElementById("importButton");
        const importStatus = document.getElementById("importStatus");
        if (selectedFile) {
          if (
            selectedFile.type === "application/json" ||
            selectedFile.name.endsWith(".json")
          ) {
            importButton.disabled = false;
            importStatus.innerHTML = `<div class="success-message">‚úÖ Selected: ${selectedFile.name}</div>`;
          } else {
            importButton.disabled = true;
            importStatus.innerHTML = `<div class="error-message">‚ùå Please select a JSON file</div>`;
          }
        } else {
          importButton.disabled = true;
          importStatus.innerHTML = "";
        }
      }
      function importFromFile() {
        if (!selectedFile) {
          alert("Please select a file first");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importData = JSON.parse(e.target.result);
            if (
              !importData.user ||
              !importData.people ||
              !importData.transactions ||
              !importData.repayments
            )
              throw new Error("Invalid backup file format");
            if (
              confirm(
                "This will replace ALL current data with the backup data. Are you sure?"
              )
            ) {
              localStorage.removeItem("lendtrack_user");
              localStorage.removeItem("lendtrack_people");
              localStorage.removeItem("lendtrack_transactions");
              localStorage.removeItem("lendtrack_repayments");
              localStorage.setItem(
                "lendtrack_user",
                JSON.stringify(importData.user)
              );
              localStorage.setItem(
                "lendtrack_people",
                JSON.stringify(importData.people)
              );
              localStorage.setItem(
                "lendtrack_transactions",
                JSON.stringify(importData.transactions)
              );
              localStorage.setItem(
                "lendtrack_repayments",
                JSON.stringify(importData.repayments)
              );
              currentUser = importData.user;
              document.getElementById("importStatus").innerHTML =
                `<div class="success-message">‚úÖ Data imported successfully! Refreshing app...</div>`;
              setTimeout(() => {
                location.reload();
              }, 2000);
            }
          } catch (error) {
            console.error("Import error:", error);
            document.getElementById("importStatus").innerHTML =
              `<div class="error-message">‚ùå Error importing file: ${error.message}</div>`;
          }
        };
        reader.readAsText(selectedFile);
      }
      function exportToCSV() {
        const people = getPeople();
        const today = getCurrentDateString();
        let csv =
          "Name,Phone,Original Principal,Interest Accrued,Total Repaid,Net Amount Due\n";
        people.forEach((person) => {
          const calculation = calculateInterestForPersonWithRepayments(
            person.id,
            today
          );
          csv += `"${person.name}","${person.phone || ""}",${calculation.originalPrincipal.toFixed(
            2
          )},${calculation.totalInterest.toFixed(
            2
          )},${calculation.totalRepaid.toFixed(
            2
          )},${calculation.netAmountDue.toFixed(2)}\n`;
        });
        downloadFile(csv, "lendtrack_export.csv", "text/csv");
      }
      function exportToJSON() {
        const people = getPeople();
        const transactions = getTransactions();
        const repayments = getRepayments();
        const today = getCurrentDateString();
        const enrichedData = people.map((person) => {
          const calculation = calculateInterestForPersonWithRepayments(
            person.id,
            today
          );
          return { person, calculation };
        });
        const data = {
          user: currentUser,
          people,
          transactions,
          repayments,
          enrichedData,
          exportDate: new Date().toISOString(),
          appVersion: "1.0.0",
        };
        const json = JSON.stringify(data, null, 2);
        const timestamp = getCurrentDateString();
        downloadFile(json, `lendtrack_backup_${timestamp}.json`, "application/json");
      }
      function downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
      // Forecast dropdown
      function populateForecastDropdown() {
        const people = getPeople();
        const dropdown = document.getElementById("forecastPerson");
        dropdown.innerHTML = '<option value="">Select a person...</option>';
        people.forEach((person) => {
          const option = document.createElement("option");
          option.value = person.id;
          option.textContent = person.name;
          dropdown.appendChild(option);
        });
      }
      // 30-day forecast per person
      function loadPersonForecast() {
        const personId = parseInt(document.getElementById("forecastPerson").value);
        const today = getCurrentDate();
        const forecastGrid = document.getElementById("forecastGrid");
        const forecastTable = document.getElementById("forecastTable");
        if (!personId) {
          forecastGrid.innerHTML =
            '<div class="no-data">Please select a person to view their forecast</div>';
          forecastTable.innerHTML = "";
          return;
        }
        const people = getPeople();
        const person = people.find((p) => p.id === personId);
        if (!person) {
          forecastGrid.innerHTML = '<div class="no-data">Person not found</div>';
          forecastTable.innerHTML = "";
          return;
        }
        const currentCalculation = calculateInterestForPersonWithRepayments(
          personId,
          getCurrentDateString()
        );
        const currentOutstanding =
          currentCalculation.originalPrincipal - currentCalculation.totalRepaid;
        if (currentOutstanding <= 0) {
          forecastGrid.innerHTML =
            '<div class="no-data">No outstanding amount for this person</div>';
          forecastTable.innerHTML = "";
          return;
        }
        const transactions = getTransactions();
        const personTransactions = transactions.filter((t) => t.personId === personId);
        const latestTransaction = personTransactions[personTransactions.length - 1];
        const interestRate = latestTransaction ? latestTransaction.interestRate : 0;
        const dailyInterest = calculateDailyInterest(currentOutstanding, interestRate, 1);
        const thirtyDayInterest = dailyInterest * 30;
        forecastGrid.innerHTML = `
                <div class="forecast-card">
                    <div class="forecast-header">${person.name}</div>
                    <div class="forecast-amount">‚Çπ${currentOutstanding.toFixed(2)}</div>
                    <div class="forecast-label">Outstanding Principal</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-header">Interest Rate</div>
                    <div class="forecast-amount">${interestRate}%</div>
                    <div class="forecast-label">Per Month</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-header">Daily Interest</div>
                    <div class="forecast-amount">‚Çπ${dailyInterest.toFixed(2)}</div>
                    <div class="forecast-label">Per Day</div>
                </div>
                <div class="forecast-card">
                    <div class="forecast-header">30-Day Total</div>
                    <div class="forecast-amount">‚Çπ${(currentOutstanding + thirtyDayInterest).toFixed(
                      2
                    )}</div>
                    <div class="forecast-label">Principal + Interest</div>
                </div>
            `;
        let tableHTML = `<h3 style="margin: 20px 0 12px 0; color: #2c3e50;">30-Day Breakdown for ${
          person.name
        }</h3>
            <table class="interest-table">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Date</th>
                        <th>Daily Interest</th>
                        <th>Principal</th>
                        <th>Total Amount</th>
                    </tr>
                </thead>
                <tbody>`;
        let runningTotal = currentOutstanding;
        for (let day = 1; day <= 30; day++) {
          const currentDate = new Date(today);
          currentDate.setDate(today.getDate() + day);
          runningTotal += dailyInterest;
          tableHTML += `<tr>
                        <td><strong>Day ${day}</strong></td>
                        <td>${currentDate.toLocaleDateString()}</td>
                        <td>‚Çπ${dailyInterest.toFixed(2)}</td>
                        <td>‚Çπ${currentOutstanding.toFixed(2)}</td>
                        <td>‚Çπ${runningTotal.toFixed(2)}</td>
                    </tr>`;
        }
        tableHTML += `</tbody></table>`;
        forecastTable.innerHTML = tableHTML;
      }
      // Add person
      function addPerson(e) {
        e.preventDefault();
        const name = document.getElementById("personName").value.trim();
        const phone = document.getElementById("personPhone").value.trim();
        const date = document.getElementById("lendDate").value;
        const amount = parseFloat(document.getElementById("lendAmount").value);
        const interestRate = parseFloat(document.getElementById("interestRate").value);
        const remarks = document.getElementById("remarks").value.trim();
        if (!name || !date || !amount || amount <= 0 || !interestRate || interestRate < 0) {
          alert("Please fill in all required fields");
          return;
        }
        const people = getPeople();
        const transactions = getTransactions();
        const personId = Date.now();
        const transactionId = Date.now() + 1;
        people.push({ id: personId, name, phone: phone || null, createdAt: new Date().toISOString() });
        transactions.push({
          id: transactionId,
          personId,
          amount,
          interestRate,
          date,
          remarks,
          type: "loan",
          createdAt: new Date().toISOString(),
        });
        savePeople(people);
        saveTransactions(transactions);
        document.getElementById("addPersonForm").reset();
        document.getElementById("lendDate").valueAsDate = getCurrentDate();
        alert("Person added successfully!");
        showTab("home");
      }
      // Load people for home tab with modern summary cards and delete buttons
      function loadPeople() {
        const people = getPeople();
        const peopleList = document.getElementById("peopleList");
        if (people.length === 0) {
          peopleList.innerHTML = '<div class="no-data">No people added yet. Click "Add Person" to get started!</div>';
          return;
        }
        peopleList.innerHTML = "";
        const today = getCurrentDateString();
        people.forEach((person) => {
          const calculation = calculateInterestForPersonWithRepayments(person.id, today);
          const personCard = document.createElement("div");
          personCard.className = "person-card";
          personCard.onclick = (e) => {
            if (e.target.classList.contains("delete-btn")) return;
            showPersonDetail(person.id);
          };
          personCard.innerHTML = `
                <button class="delete-btn" onclick="event.stopPropagation(); deletePerson(${person.id});" title="Delete Person">√ó</button>
                <div class="person-name">${person.name}</div>
                <div class="person-details">${person.phone ? `üìû ${person.phone}<br>` : ""}</div>
                <div class="modern-summary-grid">
                  <div class="modern-summary-card principal">
                    <div class="modern-icon">üíµ</div>
                    <div class="modern-label">Original Principal</div>
                    <div class="modern-value">‚Çπ${calculation.originalPrincipal.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                  </div>
                  <div class="modern-summary-card interest">
                    <div class="modern-icon">üí°</div>
                    <div class="modern-label">Interest Accrued</div>
                    <div class="modern-value">‚Çπ${calculation.totalInterest.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                  </div>
                  <div class="modern-summary-card repaid">
                    <div class="modern-icon">‚Ü©Ô∏è</div>
                    <div class="modern-label">Total Repaid</div>
                    <div class="modern-value">‚Çπ${calculation.totalRepaid.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                  </div>
                  <div class="modern-summary-card netdue">
                    <div class="modern-icon">üßæ</div>
                    <div class="modern-label">Net Amount Due</div>
                    <div class="modern-value">‚Çπ${calculation.netAmountDue.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                  </div>
                </div>
                <div class="balance ${calculation.netAmountDue > 0 ? "positive" : "negative"}">
                    Net Amount Due: ‚Çπ${calculation.netAmountDue.toLocaleString(undefined, {maximumFractionDigits: 2})}
                </div>
            `;
          peopleList.appendChild(personCard);
        });
      }
      // Calculator dropdown populate
      function populateCalculatorDropdown() {
        const people = getPeople();
        const dropdown = document.getElementById("calcPerson");
        dropdown.innerHTML = '<option value="">Select a person...</option>';
        people.forEach((person) => {
          const option = document.createElement("option");
          option.value = person.id;
          option.textContent = person.name;
          dropdown.appendChild(option);
        });
      }
      // Calculate interest submit handler
      function calculateInterest(e) {
        e.preventDefault();
        const personId = parseInt(document.getElementById("calcPerson").value);
        const upToDate = document.getElementById("calcDate").value;
        if (!personId || !upToDate) {
          alert("Please select a person and date");
          return;
        }
        const calculation = calculateInterestForPersonWithRepayments(personId, upToDate);
        document.getElementById("originalPrincipal").textContent = `‚Çπ${calculation.originalPrincipal.toFixed(
          2
        )}`;
        document.getElementById("totalInterest").textContent = `‚Çπ${calculation.totalInterest.toFixed(2)}`;
        document.getElementById("totalRepaid").textContent = `‚Çπ${calculation.totalRepaid.toFixed(2)}`;
        document.getElementById("netAmountDue").textContent = `‚Çπ${calculation.netAmountDue.toFixed(2)}`;
        const breakdownDiv = document.getElementById("interestBreakdown");
        if (calculation.timeline.length > 0) {
          let tableHTML = `<table class="interest-table">
                    <thead>
                        <tr>
                            <th>Period</th>
                            <th>Days</th>
                            <th>Principal</th>
                            <th>Rate</th>
                            <th>Interest</th>
                            <th>Event</th>
                        </tr>
                    </thead>
                    <tbody>`;
          calculation.timeline.forEach((item) => {
            const isRepayment = item.event === "repayment";
            const rowClass = isRepayment ? "repayment-highlight" : "";
            tableHTML += `<tr class="${rowClass}">
                        <td>${item.startDate} to ${item.endDate}</td>
                        <td>${item.days}</td>
                        <td>‚Çπ${item.principal.toFixed(2)}</td>
                        <td>${item.interestRate}%</td>
                        <td>‚Çπ${item.periodInterest.toFixed(2)}</td>
                        <td>${isRepayment ? `Repayment: ‚Çπ${item.repaymentAmount.toFixed(2)}` : "Interest Period"}</td>
                    </tr>`;
          });
          tableHTML += `</tbody></table>`;
          breakdownDiv.innerHTML = tableHTML;
        } else {
          breakdownDiv.innerHTML = '<div class="no-data">No timeline available</div>';
        }
        document.getElementById("calculatorResult").classList.remove("hidden");
      }
      // Show person modal detail
      function showPersonDetail(personId) {
        currentPersonId = personId;
        const people = getPeople();
        const transactions = getTransactions();
        const repayments = getRepayments();
        const person = people.find((p) => p.id === personId);
        const personTransactions = transactions.filter((t) => t.personId === personId);
        const personRepayments = repayments.filter((r) =>
          personTransactions.some((t) => t.id === r.transactionId)
        );
        document.getElementById("modalPersonName").textContent = person.name;
        const today = getCurrentDateString();
        const calculation = calculateInterestForPersonWithRepayments(personId, today);
        document.getElementById("modalPersonDetails").innerHTML = `<div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p><strong>Phone:</strong> ${person.phone || "Not provided"}</p>
                <p><strong>Original Principal:</strong> ‚Çπ${calculation.originalPrincipal.toFixed(
                  2
                )}</p>
                <p><strong>Interest Accrued:</strong> ‚Çπ${calculation.totalInterest.toFixed(
                  2
                )}</p>
                <p><strong>Total Repaid:</strong> ‚Çπ${calculation.totalRepaid.toFixed(2)}</p>
                <p><strong>Net Amount Due:</strong> ‚Çπ${calculation.netAmountDue.toFixed(
                  2
                )}</p>
            </div>`;
        const historyDiv = document.getElementById("transactionHistory");
        historyDiv.innerHTML = "";
        personTransactions.forEach((transaction) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "transaction-item loan";
          itemDiv.innerHTML = `<div><strong>Loan:</strong> ‚Çπ${transaction.amount.toFixed(2)} @ ${
            transaction.interestRate
          }% per month</div>
                        <div><strong>Date:</strong> ${transaction.date}</div>
                        ${
                          transaction.remarks
                            ? `<div><strong>Remarks:</strong> ${transaction.remarks}</div>`
                            : ""
                        }`;
          historyDiv.appendChild(itemDiv);
        });
        personRepayments.forEach((repayment) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "transaction-item";
          itemDiv.innerHTML = `<div><strong>Repayment:</strong> ‚Çπ${repayment.amount.toFixed(2)}</div>
                        <div><strong>Date:</strong> ${repayment.date}</div>
                        ${
                          repayment.remarks
                            ? `<div><strong>Remarks:</strong> ${repayment.remarks}</div>`
                            : ""
                        }`;
          historyDiv.appendChild(itemDiv);
        });
        document.getElementById("personModal").style.display = "block";
      }
      // Add repayment
      function addRepayment(e) {
        e.preventDefault();
        const amount = parseFloat(document.getElementById("repayAmount").value);
        const date = document.getElementById("repayDate").value;
        const remarks = document.getElementById("repayRemarks").value.trim();
        if (!amount || amount <= 0 || !date) {
          alert("Please fill in all required fields");
          return;
        }
        const transactions = getTransactions();
        const repayments = getRepayments();
        const personTransactions = transactions.filter((t) => t.personId === currentPersonId);
        if (personTransactions.length === 0) {
          alert("No loan transactions found for this person");
          return;
        }
        const latestTransaction = personTransactions[personTransactions.length - 1];
        repayments.push({
          id: Date.now(),
          transactionId: latestTransaction.id,
          amount,
          date,
          remarks,
          createdAt: new Date().toISOString(),
        });
        saveRepayments(repayments);
        document.getElementById("repaymentForm").reset();
        document.getElementById("repayDate").valueAsDate = getCurrentDate();
        alert("Repayment added successfully!");
        showPersonDetail(currentPersonId);
        loadPeople();
      }
      // Close modal
      function closeModal() {
        document.getElementById("personModal").style.display = "none";
      }
      // Clear all data
      function clearAllData() {
        if (
          confirm("Are you sure you want to clear all data? This cannot be undone!")
        ) {
          localStorage.removeItem("lendtrack_people");
          localStorage.removeItem("lendtrack_transactions");
          localStorage.removeItem("lendtrack_repayments");
          localStorage.removeItem("lendtrack_user");
          alert("All data cleared successfully!");
          location.reload();
        }
      }
      // Click outside modal closes
      window.onclick = function (event) {
        const modal = document.getElementById("personModal");
        if (event.target === modal) closeModal();
      };
      // Update reports tab with totals
      function updateReports() {
        const people = getPeople();
        const today = getCurrentDateString();
        let totalPrincipal = 0,
          totalInterest = 0,
          totalRepaid = 0,
          totalOutstanding = 0;
        people.forEach((person) => {
          const calculation = calculateInterestForPersonWithRepayments(person.id, today);
          totalPrincipal += calculation.originalPrincipal;
          totalInterest += calculation.totalInterest;
          totalRepaid += calculation.totalRepaid;
          totalOutstanding += calculation.netAmountDue;
        });
        const reportsGrid = document.getElementById("reportsGrid");
        reportsGrid.innerHTML = `
            <div class="reports-card">
                <div class="reports-main-figure">‚Çπ${totalPrincipal.toFixed(2)}</div>
                <div class="reports-label">Total Amount Lent</div>
            </div>
            <div class="reports-card">
                <div class="reports-main-figure">${people.length}</div>
                <div class="reports-label">Total Persons Lent</div>
            </div>
            <div class="reports-card">
                <div class="reports-main-figure">‚Çπ${totalInterest.toFixed(2)}</div>
                <div class="reports-label">Total Interest Earned</div>
            </div>
            <div class="reports-card">
                <div class="reports-main-figure">‚Çπ${totalRepaid.toFixed(2)}</div>
                <div class="reports-label">Total Repayments Made</div>
            </div>
            <div class="reports-card">
                <div class="reports-main-figure">‚Çπ${totalOutstanding.toFixed(2)}</div>
                <div class="reports-label">Total Amount Outstanding</div>
            </div>
        `;
      }
    </script>
</body>
</html>
