<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LendTrack - Secure Money Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px 15px; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
        }
        .header h1 { font-size: 2.2em; margin-bottom: 8px; font-weight: 700; }
        .header p { font-size: 1em; opacity: 0.9; }
        .sync-status {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.9);
        }
        .sync-status.synced { background: rgba(76,175,80,0.8); }
        .sync-status.syncing { background: rgba(255,193,7,0.8); }
        .sync-status.error { background: rgba(244,67,54,0.8); }
        
        /* Modern, Clean Authentication Styles */
        .auth-container { 
            max-width: 420px; 
            margin: 50px auto; 
            padding: 40px 35px; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .auth-title { 
            text-align: center; 
            margin-bottom: 35px; 
            color: #667eea; 
            font-size: 2.5em; 
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .auth-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            font-weight: 400;
        }
        .auth-tabs {
            display: flex;
            background: #f8f9ff;
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid #e6e8ff;
            padding: 4px;
        }
        .auth-tab {
            flex: 1;
            padding: 14px 16px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            color: #666;
            border-radius: 11px;
        }
        .auth-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .auth-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.08);
            color: #667eea;
        }
        .auth-section {
            display: none;
        }
        .auth-section.active {
            display: block;
        }
        
        /* Modern Signup Success Card */
        .signup-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8f1 100%);
            border: 2px solid #4caf50;
            padding: 35px 25px;
            border-radius: 18px;
            text-align: center;
            margin: 25px 0;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
        }
        .signup-success h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.6em;
            font-weight: 700;
        }
        .signup-success p {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.6;
        }
        .signup-success .email-highlight {
            background: rgba(76, 175, 80, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            margin: 12px 0;
            color: #1b5e20;
        }
        .signup-success .steps {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }
        .signup-success .steps li {
            margin-bottom: 8px;
            color: #2e7d32;
        }
        
        .verification-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
        }
        .verification-notice h3 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 1.4em;
        }
        .verification-notice p {
            color: #856404;
            margin-bottom: 18px;
        }
        
        /* Remember Me Checkbox */
        .remember-me {
            display: flex;
            align-items: center;
            margin: 20px 0;
            font-size: 14px;
            gap: 8px;
        }
        .remember-me input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }
        .remember-me label {
            margin: 0;
            cursor: pointer;
            user-select: none;
            color: #555;
        }
        
        /* Repayment Deduction Options */
        .repayment-options {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e6e8ff;
        }
        .repayment-options h4 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 16px;
        }
        .repayment-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }
        .repayment-option input[type="radio"] {
            width: auto;
            margin: 0;
        }
        .repayment-option label {
            margin: 0;
            cursor: pointer;
            color: #555;
            font-size: 14px;
        }
        
        /* Enhanced edit buttons and forms with better spacing */
        .edit-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px 6px;
            transition: all 0.3s ease;
            min-width: 36px;
            min-height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
        }
        .edit-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .delete-btn-small {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px 6px;
            transition: all 0.3s ease;
            min-width: 36px;
            min-height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
        }
        .delete-btn-small:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }
        .edit-form {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #667eea;
        }
        .edit-form h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            user-select: none;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .tab:hover:not(.active) { background: #f8f9ff; transform: translateY(-2px);}
        .tab-icon { font-size: 18px; margin-bottom: 3px; }
        .tab-text { font-size: 11px; font-weight: 500; }
        .content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .content h2 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.8em;
            font-weight: 700;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .hidden { display: none; }
        .form-group { margin-bottom: 22px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 15px; }
        input, textarea, select {
            width: 100%; padding: 16px; border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 16px; transition: all 0.3s ease; background: #fafafa;
        }
        input:focus, textarea:focus, select:focus {
            outline: none; border-color: #667eea; background: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 16px 30px; border: none; border-radius: 12px;
            cursor: pointer; font-size: 16px; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);}
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none;
        }
        .btn-success {background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);}
        .btn-danger {background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);}
        .btn-info {background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);}
        .btn-warning {background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);}
        .btn-secondary {background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);}
        
        .auth-message { padding: 14px; border-radius: 10px; margin: 18px 0; font-weight: 600; font-size: 14px;}
        .auth-message.success { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .auth-message.error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .auth-message.loading { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .auth-message.info { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        
        .auth-link {
            text-align: center;
            margin: 18px 0;
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
            display: block;
            font-weight: 500;
        }
        .auth-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        /* Copy all person-card and other styles from previous version */
        .person-card {
            background: linear-gradient(120deg, #f3f3fa 0%, #e8ecfa 100%);
            padding: 0 0 18px 0;
            margin-bottom: 18px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(120, 110, 200, 0.08);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .person-card:hover { background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15);}
        .person-card .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: all 0.3s ease;
            z-index: 2;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .person-card .delete-btn:hover {
            opacity: 1;
            transform: translateY(-2px);
            background: #ff0000;
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.4);
        }
        .person-card .edit-btn-person {
            position: absolute;
            top: 10px;
            right: 56px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: all 0.3s ease;
            z-index: 2;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .person-card .edit-btn-person:hover {
            opacity: 1;
            transform: translateY(-2px);
            background: #1976D2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .person-name { font-weight: 700; font-size: 1.17em; margin: 18px 0 8px 0; color: #2c3e50;}
        .person-details { color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 5px; text-align: center;}
        .modern-summary-grid {
            width: 95%;
            display: grid;
            grid-template-columns: repeat(2, minmax(120px, 1fr));
            gap: 16px 20px;
            margin: 0 auto 12px auto;
        }
        @media (max-width: 800px) { .modern-summary-grid { grid-template-columns: 1fr; } }
        .modern-summary-card {
            background: linear-gradient(120deg, #f3f3fa 0%, #e8ecfa 100%);
            border-radius: 13px;
            box-shadow: 0 3px 18px rgba(118, 75, 162, 0.07);
            padding: 18px 7px 11px 7px;
            text-align: center;
            border: 1.5px solid #ececff;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .modern-icon {
            font-size: 25px;
            margin-bottom: 5px;
            color: #754ba2;
            background: linear-gradient(90deg, #7f68e5 70%, #fad5ee 130%);
            border-radius: 50%;
            width: 33px;
            height: 33px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #aaa1e533;
        }
        .modern-label {
            font-size: 12.5px;
            color: #8686ad;
            margin-bottom: 4px;
            font-weight: 550;
            letter-spacing: 0.01em;
        }
        .modern-value {
            font-size: 1.15em;
            font-weight: bold;
            color: #2a2846;
            margin-bottom: 0px;
        }
        .modern-summary-card.principal  .modern-icon { background:linear-gradient(90deg,#acd8e6 70%,#f7ecfd 130%); color: #0c90c4;}
        .modern-summary-card.interest   .modern-icon { background:linear-gradient(90deg,#ffeec2 60%,#fff9ef 140%); color: #ffa900;}
        .modern-summary-card.repaid     .modern-icon { background:linear-gradient(90deg,#dbe9be 80%,#f4fdd9 130%); color: #62a656;}
        .modern-summary-card.netdue     .modern-icon { background:linear-gradient(90deg,#f8c7d6 60%,#fcf3f8 140%); color: #d73453;}
        .modern-summary-card.netdue .modern-value { color: #d73453;}
        .modern-summary-card.repaid .modern-value { color: #348d3c;}
        .modern-summary-card.interest .modern-value { color: #ffb006;}
        .modern-summary-card.principal .modern-value { color: #2385b6;}
        .balance {
            margin-top: 5px;
            font-weight: 700;
            font-size: 1em;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            user-select: none;
        }
        .balance.positive { background: #ffebee; color: #c62828; border: 2px solid #ffcdd2; }
        .balance.negative { background: #e8f5e8; color: #2e7d32; border: 2px solid #c8e6c9; }
        .no-data { text-align: center; color: #666; font-style: italic; padding: 30px; background: #f8f9ff; border-radius: 10px; margin: 15px 0;}
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(5px);}
        .modal-content { 
            background: white; 
            margin: 20px; 
            padding: 30px; 
            border-radius: 20px; 
            max-height: 85vh; 
            overflow-y: auto; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .close { 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            color: #999; 
            transition: color 0.3s ease;
            background: none;
            border: none;
            width: auto;
            padding: 0;
        }
        .close:hover { color: #333; background: none;}
        .transaction-item { 
            background: white; 
            padding: 18px; 
            margin-bottom: 15px; 
            border-radius: 12px; 
            border-left: 4px solid #4CAF50; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            position: relative;
        }
        .transaction-item.loan { border-left-color: #f44336;}
        .transaction-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 12px;
        }
        .cloud-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8f1 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #4CAF50;
        }
        .cloud-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;}
        .reports-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1.5px solid #e0e0e0; }
        .reports-main-figure { font-size: 2em; font-weight: 700; margin-bottom: 8px; color: #667eea;}
        .reports-label { color: #555; font-size: 1.0em;}
        
        /* Success/Error message styles */
        .message-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        .message-popup.success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        .message-popup.error {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px 10px;}
            .header { padding: 20px 15px;}
            .header h1 { font-size: 1.8em;}
            .tabs { flex-direction: row; overflow-x: auto; -webkit-overflow-scrolling: touch;}
            .tab { min-width: 70px; padding: 12px 8px; flex-shrink: 0;}
            .tab-icon { font-size: 16px;}
            .tab-text { font-size: 10px;}
            .content { padding: 20px;}
            .content h2 { font-size: 1.4em;}
            .modern-summary-grid, .reports-grid, .cloud-status { grid-template-columns: 1fr;}
            .person-card { padding: 15px;}
            .person-name { font-size: 1.1em;}
            .person-details { font-size: 13px;}
            .balance { font-size: 1em;}
            .modal-content { margin: 10px; padding: 20px; max-height: 90vh;}
            .auth-container { margin: 30px auto; padding: 30px 25px;}
            .auth-title { font-size: 2em;}
            .reports-main-figure { font-size: 1.5em;}
            .auth-tabs { flex-direction: column;}
            .message-popup { right: 10px; max-width: 250px;}
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px;">Connecting to Firebase...</p>
    </div>

    <!-- Modern Authentication Screen -->
    <div id="authScreen" class="auth-container hidden">
        <h2 class="auth-title">üè¶ LendTrack</h2>
        <p class="auth-subtitle">Secure Money Lending Tracker</p>
        
        <!-- Authentication Tabs -->
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="showAuthTab('signin')">Sign In</button>
            <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
            <button class="auth-tab" onclick="showAuthTab('reset')">Reset</button>
        </div>

        <!-- Sign In Section -->
        <div id="signinSection" class="auth-section active">
            <div class="form-group">
                <label for="signinEmail">Email:</label>
                <input type="email" id="signinEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="signinPassword">Password:</label>
                <input type="password" id="signinPassword" placeholder="Enter your password" required>
            </div>
            <div class="remember-me">
                <input type="checkbox" id="rememberEmail">
                <label for="rememberEmail">Remember my email</label>
            </div>
            <button onclick="signIn()" class="btn-success">Sign In</button>
            <div class="auth-link" onclick="showAuthTab('reset')">Forgot your password?</div>
        </div>

        <!-- Sign Up Section -->
        <div id="signupSection" class="auth-section">
            <div class="form-group">
                <label for="signupEmail">Email:</label>
                <input type="email" id="signupEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="signupPassword">Password:</label>
                <input type="password" id="signupPassword" placeholder="Create your password" required>
                <small style="color: #666; font-size: 12px;">Minimum 6 characters</small>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            </div>
            <button onclick="signUp()" id="signupButton" class="btn-info">Create Account</button>
        </div>

        <!-- Password Reset Section -->
        <div id="resetSection" class="auth-section">
            <div class="form-group">
                <label for="resetEmail">Email:</label>
                <input type="email" id="resetEmail" placeholder="Enter your email address" required>
            </div>
            <button onclick="resetPassword()" class="btn-warning">Send Reset Link</button>
            <div class="auth-message info">
                üìß We'll send you a password reset link if an account with this email exists.
            </div>
            <div class="auth-link" onclick="showAuthTab('signin')">Back to Sign In</div>
        </div>

        <!-- Signup Success Message -->
        <div id="signupSuccess" class="signup-success hidden">
            <h3>üéâ Account Created Successfully!</h3>
            <p>We've sent a verification email to:</p>
            <div class="email-highlight" id="successEmail">your-email@example.com</div>
            
            <div class="steps">
                <strong>Next Steps:</strong>
                <ol>
                    <li>Check your email inbox (and spam folder)</li>
                    <li>Click the verification link in the email</li>
                    <li>Return here and sign in with your credentials</li>
                </ol>
            </div>
            
            <button onclick="resendVerificationEmail()" class="btn-info" style="margin-bottom: 10px;">Resend Verification Email</button>
            <div class="auth-link" onclick="showAuthTab('signin')">Go to Sign In</div>
        </div>

        <!-- Email Verification Notice -->
        <div id="verificationNotice" class="verification-notice hidden">
            <h3>üìß Email Verification Required</h3>
            <p>Please check your email and click the verification link before you can access your account.</p>
            <button onclick="resendVerificationEmail()" class="btn-info">Resend Verification Email</button>
            <div class="auth-link" onclick="signOut()">Sign out and try with different email</div>
        </div>

        <div id="authStatus"></div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <div class="sync-status" id="syncStatus">üîÑ Syncing...</div>
            <h1>üí∞ LendTrack</h1>
            <p>Secure Money Lending Tracker with Cloud Backup</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')">
                <div class="tab-icon">üè†</div>
                <div class="tab-text">Home</div>
            </button>
            <button class="tab" onclick="showTab('add')">
                <div class="tab-icon">‚ûï</div>
                <div class="tab-text">Add Person</div>
            </button>
            <button class="tab" onclick="showTab('reports')">
                <div class="tab-icon">üìä</div>
                <div class="tab-text">Reports</div>
            </button>
            <button class="tab" onclick="showTab('calculator')">
                <div class="tab-icon">üßÆ</div>
                <div class="tab-text">Calculator</div>
            </button>
            <button class="tab" onclick="showTab('cloud')">
                <div class="tab-icon">‚òÅÔ∏è</div>
                <div class="tab-text">Cloud</div>
            </button>
        </div>

        <!-- Home Tab -->
        <div id="homeTab" class="content">
            <h2>People You've Lent Money To</h2>
            <div id="peopleList"></div>
        </div>

        <!-- Add Person Tab -->
        <div id="addTab" class="content hidden">
            <h2>Add New Person</h2>
            <form id="addPersonForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="personName">Name *</label>
                        <input type="text" id="personName" required>
                    </div>
                    <div class="form-group">
                        <label for="personPhone">Phone (Optional)</label>
                        <input type="tel" id="personPhone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="lendDate">Date of Lending *</label>
                        <input type="date" id="lendDate" required>
                    </div>
                    <div class="form-group">
                        <label for="lendAmount">Amount *</label>
                        <input type="number" id="lendAmount" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="interestRate">Interest Rate (% per month) *</label>
                    <input type="number" id="interestRate" step="0.01" required placeholder="e.g., 2.5">
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" rows="3" placeholder="Why you lent the money..."></textarea>
                </div>
                <button type="submit" class="btn-success">Add Person</button>
            </form>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="content hidden">
            <h2>Reports</h2>
            <div id="reportsGrid" class="reports-grid"></div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculatorTab" class="content hidden">
            <h2>Interest Calculator</h2>
            <form id="calculatorForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="calcPerson">Select Person</label>
                        <select id="calcPerson" required>
                            <option value="">Select a person...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="calcDate">Calculate up to Date</label>
                        <input type="date" id="calcDate" required>
                    </div>
                </div>
                <button type="submit" class="btn-success">Calculate</button>
            </form>
            <div id="calculatorResult" class="hidden">
                <h3 style="margin: 20px 0 15px 0; color: #2c3e50;">Calculation Results</h3>
                <div class="modern-summary-grid">
                    <div class="modern-summary-card principal">
                        <div class="modern-icon">üíµ</div>
                        <div class="modern-label">Original Principal</div>
                        <div class="modern-value" id="originalPrincipal">‚Çπ0</div>
                    </div>
                    <div class="modern-summary-card interest">
                        <div class="modern-icon">üí°</div>
                        <div class="modern-label">Total Interest</div>
                        <div class="modern-value" id="totalInterest">‚Çπ0</div>
                    </div>
                    <div class="modern-summary-card repaid">
                        <div class="modern-icon">‚Ü©Ô∏è</div>
                        <div class="modern-label">Total Repaid</div>
                        <div class="modern-value" id="totalRepaid">‚Çπ0</div>
                    </div>
                    <div class="modern-summary-card netdue">
                        <div class="modern-icon">üßæ</div>
                        <div class="modern-label">Net Amount Due</div>
                        <div class="modern-value" id="netAmountDue">‚Çπ0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloud Backup Tab -->
        <div id="cloudTab" class="content hidden">
            <h2>‚òÅÔ∏è Cloud Backup Status</h2>
            <div class="cloud-info">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üîÑ Real-Time Sync</h3>
                <p>Your data is automatically backed up to Firebase every time you make changes. No manual backup needed!</p>
            </div>
            <div class="cloud-status">
                <div class="status-card">
                    <h4>üìä Sync Status</h4>
                    <p id="lastSync">Last sync: Never</p>
                    <p id="dataCount">0 people, 0 transactions backed up</p>
                </div>
                <div class="status-card">
                    <h4>üë§ Account</h4>
                    <p id="userEmail">Not signed in</p>
                    <p id="emailVerified">Email verification: Unknown</p>
                    <button onclick="signOut()" class="btn-danger" style="margin-top: 10px;">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Person Detail Modal -->
    <div id="personModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="closeModal()">&times;</button>
            <h2 id="modalPersonName" style="margin-bottom: 20px; color: #2c3e50;"></h2>
            <div id="modalPersonDetails" style="margin-bottom: 25px;"></div>
            
            <!-- Edit Person Form (initially hidden) -->
            <div id="editPersonForm" class="edit-form hidden">
                <h4>Edit Person Details</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editPersonName">Name</label>
                        <input type="text" id="editPersonName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPersonPhone">Phone</label>
                        <input type="tel" id="editPersonPhone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editLendAmount">Principal Amount</label>
                        <input type="number" id="editLendAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editInterestRate">Interest Rate (%/month)</label>
                        <input type="number" id="editInterestRate" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editRemarks">Remarks</label>
                    <textarea id="editRemarks" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="savePersonEdit()" class="btn-success" style="flex: 1;">Save Changes</button>
                    <button onclick="cancelPersonEdit()" class="btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button onclick="showEditPersonForm()" class="edit-btn" style="flex: 1;">‚úèÔ∏è Edit Person</button>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #2c3e50;">üí∞ Add Repayment</h3>
            <form id="repaymentForm" class="edit-form" style="border-color: #4CAF50; background: #f0fff0;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="repayAmount">Amount *</label>
                        <input type="number" id="repayAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="repayDate">Date *</label>
                        <input type="date" id="repayDate" required>
                    </div>
                </div>
                <div class="repayment-options">
                    <h4>Deduct From:</h4>
                    <div class="repayment-option">
                        <input type="radio" id="deductPrincipal" name="deductFrom" value="principal" checked>
                        <label for="deductPrincipal">Principal Amount</label>
                    </div>
                    <div class="repayment-option">
                        <input type="radio" id="deductInterest" name="deductFrom" value="interest">
                        <label for="deductInterest">Interest Amount</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="repayRemarks">Remarks</label>
                    <input type="text" id="repayRemarks" placeholder="Optional">
                </div>
                <button type="submit" class="btn-success">üí≥ Add Repayment</button>
            </form>
            
            <h3 style="margin: 25px 0 15px 0; color: #2c3e50;">üìã Transaction History</h3>
            <div id="transactionHistory"></div>
            
            <!-- Edit Repayment Form (initially hidden) -->
            <div id="editRepaymentForm" class="edit-form hidden">
                <h4>Edit Repayment</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editRepayAmount">Amount</label>
                        <input type="number" id="editRepayAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editRepayDate">Date</label>
                        <input type="date" id="editRepayDate" required>
                    </div>
                </div>
                <div class="repayment-options">
                    <h4>Deduct From:</h4>
                    <div class="repayment-option">
                        <input type="radio" id="editDeductPrincipal" name="editDeductFrom" value="principal">
                        <label for="editDeductPrincipal">Principal Amount</label>
                    </div>
                    <div class="repayment-option">
                        <input type="radio" id="editDeductInterest" name="editDeductFrom" value="interest">
                        <label for="editDeductInterest">Interest Amount</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editRepayRemarks">Remarks</label>
                    <input type="text" id="editRepayRemarks">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveRepaymentEdit()" class="btn-success" style="flex: 1;">Save Changes</button>
                    <button onclick="cancelRepaymentEdit()" class="btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase CDN Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut as firebaseSignOut, 
            onAuthStateChanged,
            sendEmailVerification,
            sendPasswordResetEmail,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDBMAEDZ5cthmlj3-WWWFyDbvhTjhsPbF4",
            authDomain: "lendtrack-79cc6.firebaseapp.com",
            projectId: "lendtrack-79cc6",
            storageBucket: "lendtrack-79cc6.firebasestorage.app",
            messagingSenderId: "406324179619",
            appId: "1:406324179619:web:1a71382505c2c707d34516",
            measurementId: "G-MNXWSFXMM5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let currentPersonId = null;
        let currentEditingRepaymentId = null;
        let peopleData = [];
        let transactionsData = [];
        let repaymentsData = [];

        // Make functions global for HTML access
        window.showAuthTab = showAuthTab;
        window.signIn = signIn;
        window.signUp = signUp;
        window.signOut = signOut;
        window.resetPassword = resetPassword;
        window.resendVerificationEmail = resendVerificationEmail;
        window.showTab = showTab;
        window.closeModal = closeModal;
        window.addPerson = addPerson;
        window.addRepayment = addRepayment;
        window.deletePerson = deletePerson;
        window.showPersonDetail = showPersonDetail;
        window.calculateInterest = calculateInterest;
        window.showEditPersonForm = showEditPersonForm;
        window.savePersonEdit = savePersonEdit;
        window.cancelPersonEdit = cancelPersonEdit;
        window.editRepayment = editRepayment;
        window.saveRepaymentEdit = saveRepaymentEdit;
        window.cancelRepaymentEdit = cancelRepaymentEdit;
        window.deleteRepayment = deleteRepayment;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const today = getCurrentDate();
            const todayString = getCurrentDateString();
            
            // Set default dates
            if (document.getElementById('lendDate')) document.getElementById('lendDate').value = todayString;
            if (document.getElementById('repayDate')) document.getElementById('repayDate').value = todayString;
            if (document.getElementById('calcDate')) document.getElementById('calcDate').value = todayString;
            
            // Load remembered email
            loadRememberedEmail();
            
            // Setup form listeners
            if (document.getElementById('addPersonForm')) {
                document.getElementById('addPersonForm').addEventListener('submit', addPerson);
            }
            if (document.getElementById('repaymentForm')) {
                document.getElementById('repaymentForm').addEventListener('submit', addRepayment);
            }
            if (document.getElementById('calculatorForm')) {
                document.getElementById('calculatorForm').addEventListener('submit', calculateInterest);
            }
            
            // Listen for auth state changes with auto-logout fix
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    if (user.emailVerified) {
                        showMainApp();
                        loadAllData();
                    } else {
                        // Fix: If user is signed in but email not verified, sign them out
                        firebaseSignOut(auth).then(() => {
                            showEmailVerificationNotice();
                        });
                    }
                } else {
                    currentUser = null;
                    showAuthScreen();
                }
                hideLoadingScreen();
            });
        });

        // Enhanced message popup system
        function showMessage(message, type = 'success') {
            // Remove any existing message
            const existingMessage = document.querySelector('.message-popup');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message popup
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-popup ${type}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (messageDiv && messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 4000);
        }

        // Email remembering functions
        function saveRememberedEmail(email) {
            if (document.getElementById('rememberEmail').checked) {
                localStorage.setItem('lendtrack_remembered_email', email);
            } else {
                localStorage.removeItem('lendtrack_remembered_email');
            }
        }

        function loadRememberedEmail() {
            const rememberedEmail = localStorage.getItem('lendtrack_remembered_email');
            if (rememberedEmail) {
                document.getElementById('signinEmail').value = rememberedEmail;
                document.getElementById('rememberEmail').checked = true;
            }
        }

        // Enhanced Authentication functions
        function showAuthTab(tabName) {
            // Remove active class from all tabs and sections
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-section').forEach(section => section.classList.remove('active'));
            
            // Hide success/notice screens
            document.getElementById('signupSuccess').classList.add('hidden');
            document.getElementById('verificationNotice').classList.add('hidden');
            
            // Add active class to selected tab and section
            event.target.classList.add('active');
            document.getElementById(tabName + 'Section').classList.add('active');
            
            // Clear previous messages
            showAuthStatus('', 'clear');
            
            // Auto-fill reset email if coming from signin
            if (tabName === 'reset') {
                const signinEmail = document.getElementById('signinEmail').value;
                if (signinEmail) {
                    document.getElementById('resetEmail').value = signinEmail;
                }
            }
        }

        async function signUp() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            // Basic validation
            if (!email || !password || !confirmPassword) {
                showAuthStatus('Please fill in all fields', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showAuthStatus('Please enter a valid email address', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthStatus('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthStatus('Passwords do not match', 'error');
                return;
            }
            
            try {
                showAuthStatus('Creating account...', 'loading');
                
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Send email verification
                await sendEmailVerification(user);
                
                // Show success message with clear instructions
                showSignupSuccess(email);
                
            } catch (error) {
                console.error('Sign up error:', error);
                showAuthStatus(getAuthErrorMessage(error.code), 'error');
            }
        }

        function showSignupSuccess(email) {
            // Hide all sections and tabs
            document.querySelectorAll('.auth-section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            
            // Show success screen
            document.getElementById('signupSuccess').classList.remove('hidden');
            document.getElementById('successEmail').textContent = email;
            
            showAuthStatus('', 'clear');
        }

        async function signIn() {
            const email = document.getElementById('signinEmail').value.trim();
            const password = document.getElementById('signinPassword').value.trim();
            
            if (!email || !password) {
                showAuthStatus('Please enter both email and password', 'error');
                return;
            }
            
            try {
                showAuthStatus('Signing in...', 'loading');
                
                // Save email if remember is checked
                saveRememberedEmail(email);
                
                await signInWithEmailAndPassword(auth, email, password);
                
                // Auth state change will handle the rest
                
            } catch (error) {
                console.error('Sign in error:', error);
                showAuthStatus(getAuthErrorMessage(error.code), 'error');
            }
        }

        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            
            if (!email) {
                showAuthStatus('Please enter your email address', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showAuthStatus('Please enter a valid email address', 'error');
                return;
            }
            
            try {
                showAuthStatus('Sending reset link...', 'loading');
                await sendPasswordResetEmail(auth, email);
                showAuthStatus('Password reset link sent! Check your email.', 'success');
            } catch (error) {
                console.error('Password reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showAuthStatus('Reset link sent if account exists.', 'info');
                } else {
                    showAuthStatus(getAuthErrorMessage(error.code), 'error');
                }
            }
        }

        async function resendVerificationEmail() {
            if (currentUser && !currentUser.emailVerified) {
                try {
                    await sendEmailVerification(currentUser);
                    showAuthStatus('Verification email sent! Check your inbox.', 'success');
                } catch (error) {
                    console.error('Resend verification error:', error);
                    showAuthStatus('Error sending email. Please try again.', 'error');
                }
            }
        }

        async function signOut() {
            try {
                await firebaseSignOut(auth);
                showAuthScreen();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Validation functions
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // UI functions
        function showLoadingScreen() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('signupSuccess').classList.add('hidden');
            document.getElementById('verificationNotice').classList.add('hidden');
        }

        function showEmailVerificationNotice() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('signupSuccess').classList.add('hidden');
            document.getElementById('verificationNotice').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('signupSuccess').classList.add('hidden');
            document.getElementById('verificationNotice').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateCloudStatus();
        }

        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            if (type === 'clear' || !message) {
                statusDiv.innerHTML = '';
                return;
            }
            statusDiv.innerHTML = `<div class="auth-message ${type}">${message}</div>`;
        }

        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/user-not-found': 'No account found with this email address.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/email-already-in-use': 'An account with this email already exists.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/operation-not-allowed': 'Email/password accounts are not enabled.',
                'auth/network-request-failed': 'Network error. Please check your connection.'
            };
            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.className = `sync-status ${status}`;
                syncStatus.textContent = message;
            }
        }

        function updateCloudStatus() {
            if (currentUser) {
                const userEmailEl = document.getElementById('userEmail');
                const emailVerifiedEl = document.getElementById('emailVerified');
                const lastSyncEl = document.getElementById('lastSync');
                const dataCountEl = document.getElementById('dataCount');
                
                if (userEmailEl) userEmailEl.textContent = currentUser.email;
                if (emailVerifiedEl) emailVerifiedEl.textContent = `Email verification: ${currentUser.emailVerified ? '‚úÖ Verified' : '‚ùå Not verified'}`;
                if (lastSyncEl) lastSyncEl.textContent = `Last sync: ${new Date().toLocaleString()}`;
                if (dataCountEl) dataCountEl.textContent = `${peopleData.length} people, ${transactionsData.length} transactions backed up`;
            }
        }

        // Data functions
        async function loadAllData() {
            if (!currentUser || !currentUser.emailVerified) return;
            
            try {
                updateSyncStatus('syncing', 'üîÑ Loading data...');
                
                // Load people
                const peopleQuery = query(collection(db, 'people'), where('userId', '==', currentUser.uid));
                const peopleSnapshot = await getDocs(peopleQuery);
                peopleData = peopleSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load transactions
                const transactionsQuery = query(collection(db, 'transactions'), where('userId', '==', currentUser.uid));
                const transactionsSnapshot = await getDocs(transactionsQuery);
                transactionsData = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load repayments
                const repaymentsQuery = query(collection(db, 'repayments'), where('userId', '==', currentUser.uid));
                const repaymentsSnapshot = await getDocs(repaymentsQuery);
                repaymentsData = repaymentsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateSyncStatus('synced', '‚úÖ Synced');
                loadPeople();
                updateReports();
                populateCalculatorDropdown();
                updateCloudStatus();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateSyncStatus('error', '‚ùå Sync error');
            }
        }

        // Utility functions
        function getCurrentDate() { return new Date(); }
        function getCurrentDateString() { return getCurrentDate().toISOString().split('T')[0]; }

        function getDaysBetween(startDate, endDate) {
            const start = new Date(startDate), end = new Date(endDate);
            const timeDiff = end.getTime() - start.getTime();
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        function calculateDailyInterest(principal, monthlyRate, days) {
            const dailyRate = monthlyRate / 30;
            return principal * (dailyRate / 100) * days;
        }

        // Enhanced Interest Calculation with Principal/Interest Deduction
        function calculateInterestForPersonWithRepayments(personId, upToDate) {
            const personTransactions = transactionsData.filter(t => t.personId === personId);
            const personRepayments = repaymentsData.filter(r =>
                personTransactions.some(t => t.id === r.transactionId)
            ).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let totalPrincipal = 0, totalInterest = 0, totalRepaid = 0;
            
            personTransactions.forEach(transaction => {
                const principal = transaction.amount;
                const interestRate = transaction.interestRate;
                const startDate = new Date(transaction.date);
                const endDate = new Date(upToDate);
                totalPrincipal += principal;
                
                const transactionRepayments = personRepayments.filter(r => r.transactionId === transaction.id);
                
                let currentPrincipal = principal, currentDate = new Date(startDate), transactionInterest = 0;
                let interestPaid = 0;
                
                let events = transactionRepayments.map(r => ({
                    date: new Date(r.date), 
                    type: 'repayment', 
                    amount: r.amount,
                    deductFrom: r.deductFrom || 'principal'
                }));
                events.push({ date: endDate, type: 'calculation_end', amount: 0 });
                events.sort((a, b) => a.date - b.date);
                
                events.forEach(event => {
                    if (event.date >= currentDate) {
                        const days = getDaysBetween(currentDate, event.date);
                        if (days > 0 && currentPrincipal > 0) {
                            const periodInterest = calculateDailyInterest(currentPrincipal, interestRate, days);
                            transactionInterest += periodInterest;
                        }
                        
                        currentDate = new Date(event.date);
                        
                        if (event.type === 'repayment') {
                            if (event.deductFrom === 'interest') {
                                interestPaid += event.amount;
                            } else {
                                currentPrincipal = Math.max(0, currentPrincipal - event.amount);
                            }
                            totalRepaid += event.amount;
                        }
                    }
                });
                
                totalInterest += Math.max(0, transactionInterest - interestPaid);
            });
            
            const netAmountDue = totalPrincipal + totalInterest - totalRepaid;
            return { originalPrincipal: totalPrincipal, totalInterest, totalRepaid, netAmountDue };
        }

        // Enhanced app functions with editing capabilities
        async function addPerson(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.emailVerified) {
                showMessage('Please verify your email before adding data', 'error');
                return;
            }
            
            const name = document.getElementById('personName').value.trim();
            const phone = document.getElementById('personPhone').value.trim();
            const date = document.getElementById('lendDate').value;
            const amount = parseFloat(document.getElementById('lendAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const remarks = document.getElementById('remarks').value.trim();
            
            if (!name || !date || !amount || amount <= 0 || !interestRate || interestRate < 0) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'üîÑ Saving...');
                
                // Add person to Firebase
                const personDoc = await addDoc(collection(db, 'people'), {
                    userId: currentUser.uid,
                    name,
                    phone: phone || null,
                    createdAt: new Date().toISOString()
                });
                
                // Add transaction to Firebase
                await addDoc(collection(db, 'transactions'), {
                    userId: currentUser.uid,
                    personId: personDoc.id,
                    amount,
                    interestRate,
                    date,
                    remarks,
                    type: 'loan',
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('addPersonForm').reset();
                document.getElementById('lendDate').value = getCurrentDateString();
                
                updateSyncStatus('synced', '‚úÖ Saved');
                showMessage('Person added successfully!', 'success');
                await loadAllData();
                showTab('home');
                
            } catch (error) {
                console.error('Error adding person:', error);
                updateSyncStatus('error', '‚ùå Save failed');
                showMessage('Error saving data. Please try again.', 'error');
            }
        }

        async function deletePerson(personId) {
            if (!currentUser || !currentUser.emailVerified || !confirm('Are you sure you want to delete this person and all their data?')) return;
            
            try {
                updateSyncStatus('syncing', 'üîÑ Deleting...');
                
                // Delete person
                await deleteDoc(doc(db, 'people', personId));
                
                // Delete associated transactions and repayments
                const personTransactions = transactionsData.filter(t => t.personId === personId);
                for (const transaction of personTransactions) {
                    await deleteDoc(doc(db, 'transactions', transaction.id));
                    
                    const transactionRepayments = repaymentsData.filter(r => r.transactionId === transaction.id);
                    for (const repayment of transactionRepayments) {
                        await deleteDoc(doc(db, 'repayments', repayment.id));
                    }
                }
                
                updateSyncStatus('synced', '‚úÖ Deleted');
                await loadAllData();
                showMessage('Person deleted successfully!', 'success');
                
            } catch (error) {
                console.error('Error deleting person:', error);
                updateSyncStatus('error', '‚ùå Delete failed');
                showMessage('Error deleting person. Please try again.', 'error');
            }
        }

        // Person editing functions
        function showEditPersonForm() {
            const person = peopleData.find(p => p.id === currentPersonId);
            const personTransaction = transactionsData.find(t => t.personId === currentPersonId);
            
            if (!person || !personTransaction) return;
            
            document.getElementById('editPersonName').value = person.name || '';
            document.getElementById('editPersonPhone').value = person.phone || '';
            document.getElementById('editLendAmount').value = personTransaction.amount || '';
            document.getElementById('editInterestRate').value = personTransaction.interestRate || '';
            document.getElementById('editRemarks').value = personTransaction.remarks || '';
            
            document.getElementById('editPersonForm').classList.remove('hidden');
        }

        async function savePersonEdit() {
            if (!currentUser || !currentPersonId) return;
            
            const name = document.getElementById('editPersonName').value.trim();
            const phone = document.getElementById('editPersonPhone').value.trim();
            const amount = parseFloat(document.getElementById('editLendAmount').value);
            const interestRate = parseFloat(document.getElementById('editInterestRate').value);
            const remarks = document.getElementById('editRemarks').value.trim();
            
            if (!name || !amount || amount <= 0 || !interestRate || interestRate < 0) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'üîÑ Updating...');
                
                // Update person
                await updateDoc(doc(db, 'people', currentPersonId), {
                    name,
                    phone: phone || null,
                    updatedAt: new Date().toISOString()
                });
                
                // Update transaction
                const personTransaction = transactionsData.find(t => t.personId === currentPersonId);
                if (personTransaction) {
                    await updateDoc(doc(db, 'transactions', personTransaction.id), {
                        amount,
                        interestRate,
                        remarks,
                        updatedAt: new Date().toISOString()
                    });
                }
                
                updateSyncStatus('synced', '‚úÖ Updated');
                showMessage('Person details updated successfully!', 'success');
                cancelPersonEdit();
                await loadAllData();
                showPersonDetail(currentPersonId);
                
            } catch (error) {
                console.error('Error updating person:', error);
                updateSyncStatus('error', '‚ùå Update failed');
                showMessage('Error updating person. Please try again.', 'error');
            }
        }

        function cancelPersonEdit() {
            document.getElementById('editPersonForm').classList.add('hidden');
        }

        // Enhanced repayment function with deduction choice
        async function addRepayment(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.emailVerified || !currentPersonId) return;
            
            const amount = parseFloat(document.getElementById('repayAmount').value);
            const date = document.getElementById('repayDate').value;
            const remarks = document.getElementById('repayRemarks').value.trim();
            const deductFrom = document.querySelector('input[name="deductFrom"]:checked').value;
            
            if (!amount || amount <= 0 || !date) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'üîÑ Saving...');
                
                const personTransactions = transactionsData.filter(t => t.personId === currentPersonId);
                if (personTransactions.length === 0) {
                    showMessage('No loan transactions found for this person', 'error');
                    return;
                }
                
                const latestTransaction = personTransactions[personTransactions.length - 1];
                
                await addDoc(collection(db, 'repayments'), {
                    userId: currentUser.uid,
                    transactionId: latestTransaction.id,
                    amount,
                    date,
                    remarks,
                    deductFrom,
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('repaymentForm').reset();
                document.getElementById('repayDate').value = getCurrentDateString();
                document.getElementById('deductPrincipal').checked = true;
                
                updateSyncStatus('synced', '‚úÖ Saved');
                showMessage(`Repayment added successfully! (Deducted from ${deductFrom})`, 'success');
                await loadAllData();
                showPersonDetail(currentPersonId);
                
            } catch (error) {
                console.error('Error adding repayment:', error);
                updateSyncStatus('error', '‚ùå Save failed');
                showMessage('Error saving repayment. Please try again.', 'error');
            }
        }

        // Repayment editing functions
        function editRepayment(repaymentId) {
            currentEditingRepaymentId = repaymentId;
            const repayment = repaymentsData.find(r => r.id === repaymentId);
            
            if (!repayment) return;
            
            document.getElementById('editRepayAmount').value = repayment.amount || '';
            document.getElementById('editRepayDate').value = repayment.date || '';
            document.getElementById('editRepayRemarks').value = repayment.remarks || '';
            
            // Set radio button
            if (repayment.deductFrom === 'interest') {
                document.getElementById('editDeductInterest').checked = true;
            } else {
                document.getElementById('editDeductPrincipal').checked = true;
            }
            
            document.getElementById('editRepaymentForm').classList.remove('hidden');
        }

        async function saveRepaymentEdit() {
            if (!currentUser || !currentEditingRepaymentId) return;
            
            const amount = parseFloat(document.getElementById('editRepayAmount').value);
            const date = document.getElementById('editRepayDate').value;
            const remarks = document.getElementById('editRepayRemarks').value.trim();
            const deductFrom = document.querySelector('input[name="editDeductFrom"]:checked').value;
            
            if (!amount || amount <= 0 || !date) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'üîÑ Updating...');
                
                await updateDoc(doc(db, 'repayments', currentEditingRepaymentId), {
                    amount,
                    date,
                    remarks,
                    deductFrom,
                    updatedAt: new Date().toISOString()
                });
                
                updateSyncStatus('synced', '‚úÖ Updated');
                showMessage('Repayment updated successfully!', 'success');
                cancelRepaymentEdit();
                await loadAllData();
                showPersonDetail(currentPersonId);
                
            } catch (error) {
                console.error('Error updating repayment:', error);
                updateSyncStatus('error', '‚ùå Update failed');
                showMessage('Error updating repayment. Please try again.', 'error');
            }
        }

        function cancelRepaymentEdit() {
            document.getElementById('editRepaymentForm').classList.add('hidden');
            currentEditingRepaymentId = null;
        }

        async function deleteRepayment(repaymentId) {
            if (!currentUser || !confirm('Are you sure you want to delete this repayment?')) return;
            
            try {
                updateSyncStatus('syncing', 'üîÑ Deleting...');
                
                await deleteDoc(doc(db, 'repayments', repaymentId));
                
                updateSyncStatus('synced', '‚úÖ Deleted');
                showMessage('Repayment deleted successfully!', 'success');
                await loadAllData();
                showPersonDetail(currentPersonId);
                
            } catch (error) {
                console.error('Error deleting repayment:', error);
                updateSyncStatus('error', '‚ùå Delete failed');
                showMessage('Error deleting repayment. Please try again.', 'error');
            }
        }

        function loadPeople() {
            const peopleList = document.getElementById('peopleList');
            if (!peopleList) return;
            
            if (peopleData.length === 0) {
                peopleList.innerHTML = '<div class="no-data">No people added yet. Click "Add Person" to get started!</div>';
                return;
            }
            
            peopleList.innerHTML = '';
            const today = getCurrentDateString();
            
            peopleData.forEach(person => {
                const calculation = calculateInterestForPersonWithRepayments(person.id, today);
                const personCard = document.createElement('div');
                personCard.className = 'person-card';
                personCard.onclick = (e) => {
                    if (e.target.classList.contains('delete-btn') || e.target.classList.contains('edit-btn-person')) return;
                    showPersonDetail(person.id);
                };
                
                personCard.innerHTML = `
                    <button class="edit-btn-person" onclick="event.stopPropagation(); showPersonDetail('${person.id}'); showEditPersonForm();" title="Edit Person">‚úèÔ∏è</button>
                    <button class="delete-btn" onclick="event.stopPropagation(); deletePerson('${person.id}');" title="Delete Person">√ó</button>
                    <div class="person-name">${person.name}</div>
                    <div class="person-details">${person.phone ? `üìû ${person.phone}<br>` : ''}</div>
                    <div class="modern-summary-grid">
                        <div class="modern-summary-card principal">
                            <div class="modern-icon">üíµ</div>
                            <div class="modern-label">Original Principal</div>
                            <div class="modern-value">‚Çπ${calculation.originalPrincipal.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="modern-summary-card interest">
                            <div class="modern-icon">üí°</div>
                            <div class="modern-label">Interest Accrued</div>
                            <div class="modern-value">‚Çπ${calculation.totalInterest.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="modern-summary-card repaid">
                            <div class="modern-icon">‚Ü©Ô∏è</div>
                            <div class="modern-label">Total Repaid</div>
                            <div class="modern-value">‚Çπ${calculation.totalRepaid.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="modern-summary-card netdue">
                            <div class="modern-icon">üßæ</div>
                            <div class="modern-label">Net Amount Due</div>
                            <div class="modern-value">‚Çπ${calculation.netAmountDue.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    <div class="balance ${calculation.netAmountDue > 0 ? 'positive' : 'negative'}">
                        Net Amount Due: ‚Çπ${calculation.netAmountDue.toLocaleString(undefined, {maximumFractionDigits: 2})}
                    </div>
                `;
                peopleList.appendChild(personCard);
            });
        }

        function showPersonDetail(personId) {
            currentPersonId = personId;
            const person = peopleData.find(p => p.id === personId);
            const personTransactions = transactionsData.filter(t => t.personId === personId);
            const personRepayments = repaymentsData.filter(r =>
                personTransactions.some(t => t.id === r.transactionId)
            );
            
            document.getElementById('modalPersonName').textContent = person.name;
            const today = getCurrentDateString();
            const calculation = calculateInterestForPersonWithRepayments(personId, today);
            
            document.getElementById('modalPersonDetails').innerHTML = `
                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #667eea;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>üìû Phone:</strong> ${person.phone || 'Not provided'}</div>
                        <div><strong>üíµ Principal:</strong> ‚Çπ${calculation.originalPrincipal.toFixed(2)}</div>
                        <div><strong>üí° Interest:</strong> ‚Çπ${calculation.totalInterest.toFixed(2)}</div>
                        <div><strong>‚Ü©Ô∏è Repaid:</strong> ‚Çπ${calculation.totalRepaid.toFixed(2)}</div>
                        <div><strong>üßæ Net Due:</strong> <span style="color: ${calculation.netAmountDue > 0 ? '#d73453' : '#348d3c'};">‚Çπ${calculation.netAmountDue.toFixed(2)}</span></div>
                    </div>
                </div>
            `;
            
            const historyDiv = document.getElementById('transactionHistory');
            historyDiv.innerHTML = '';
            
            // Show loan transactions
            personTransactions.forEach(transaction => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'transaction-item loan';
                itemDiv.innerHTML = `
                    <div><strong>üí∞ Loan:</strong> ‚Çπ${transaction.amount.toFixed(2)} @ ${transaction.interestRate}% per month</div>
                    <div><strong>üìÖ Date:</strong> ${transaction.date}</div>
                    ${transaction.remarks ? `<div><strong>üìù Remarks:</strong> ${transaction.remarks}</div>` : ''}
                `;
                historyDiv.appendChild(itemDiv);
            });
            
            // Show repayment transactions
            personRepayments.forEach(repayment => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'transaction-item';
                const deductFromText = repayment.deductFrom === 'interest' ? ' (deducted from interest)' : ' (deducted from principal)';
                itemDiv.innerHTML = `
                    <div class="transaction-actions">
                        <button class="edit-btn" onclick="editRepayment('${repayment.id}')">‚úèÔ∏è</button>
                        <button class="delete-btn-small" onclick="deleteRepayment('${repayment.id}')">üóëÔ∏è</button>
                    </div>
                    <div><strong>üí≥ Repayment:</strong> ‚Çπ${repayment.amount.toFixed(2)}${deductFromText}</div>
                    <div><strong>üìÖ Date:</strong> ${repayment.date}</div>
                    ${repayment.remarks ? `<div><strong>üìù Remarks:</strong> ${repayment.remarks}</div>` : ''}
                `;
                historyDiv.appendChild(itemDiv);
            });
            
            // Hide edit forms
            document.getElementById('editPersonForm').classList.add('hidden');
            document.getElementById('editRepaymentForm').classList.add('hidden');
            
            document.getElementById('personModal').style.display = 'block';
        }

        function populateCalculatorDropdown() {
            const dropdown = document.getElementById('calcPerson');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">Select a person...</option>';
            peopleData.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                dropdown.appendChild(option);
            });
        }

        function calculateInterest(e) {
            e.preventDefault();
            const personId = document.getElementById('calcPerson').value;
            const upToDate = document.getElementById('calcDate').value;
            
            if (!personId || !upToDate) {
                showMessage('Please select a person and date', 'error');
                return;
            }
            
            const calculation = calculateInterestForPersonWithRepayments(personId, upToDate);
            document.getElementById('originalPrincipal').textContent = `‚Çπ${calculation.originalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `‚Çπ${calculation.totalInterest.toFixed(2)}`;
            document.getElementById('totalRepaid').textContent = `‚Çπ${calculation.totalRepaid.toFixed(2)}`;
            document.getElementById('netAmountDue').textContent = `‚Çπ${calculation.netAmountDue.toFixed(2)}`;
            
            document.getElementById('calculatorResult').classList.remove('hidden');
        }

        function updateReports() {
            const today = getCurrentDateString();
            let totalPrincipal = 0, totalInterest = 0, totalRepaid = 0, totalOutstanding = 0;
            
            peopleData.forEach(person => {
                const calculation = calculateInterestForPersonWithRepayments(person.id, today);
                totalPrincipal += calculation.originalPrincipal;
                totalInterest += calculation.totalInterest;
                totalRepaid += calculation.totalRepaid;
                totalOutstanding += calculation.netAmountDue;
            });
            
            const reportsGrid = document.getElementById('reportsGrid');
            if (!reportsGrid) return;
            
            reportsGrid.innerHTML = `
                <div class="reports-card">
                    <div class="reports-main-figure">‚Çπ${totalPrincipal.toFixed(2)}</div>
                    <div class="reports-label">Total Amount Lent</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">${peopleData.length}</div>
                    <div class="reports-label">Total Persons Lent</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">‚Çπ${totalInterest.toFixed(2)}</div>
                    <div class="reports-label">Total Interest Earned</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">‚Çπ${totalRepaid.toFixed(2)}</div>
                    <div class="reports-label">Total Repayments Made</div>
                </div>
                <div class="reports-card">
                    <div class="reports-main-figure">‚Çπ${totalOutstanding.toFixed(2)}</div>
                    <div class="reports-label">Total Amount Outstanding</div>
                </div>
            `;
        }

        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            // Close modal when switching tabs
            closeModal();
            
            if (tabName === 'home') loadPeople();
            else if (tabName === 'calculator') populateCalculatorDropdown();
            else if (tabName === 'reports') updateReports();
            else if (tabName === 'cloud') updateCloudStatus();
        }

        function closeModal() {
            const modal = document.getElementById('personModal');
            if (modal) {
                modal.style.display = 'none';
                // Hide edit forms when closing modal
                document.getElementById('editPersonForm').classList.add('hidden');
                document.getElementById('editRepaymentForm').classList.add('hidden');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('personModal');
            if (event.target === modal) closeModal();
        }

    </script>
</body>
</html>
